{"code":"/*\r\n * Copyright (c) 2022 SAP SE or an SAP affiliate company. All rights reserved.\r\n */\r\n/**\r\n * Copyright (c) 2019 SAP SE or an SAP affiliate company. All rights reserved.\r\n * @module smartutils\r\n */\r\n/*\r\n * Copyright (c) 2019 SAP SE or an SAP affiliate company. All rights reserved.\r\n */\r\nimport { __decorate, __metadata, __param } from \"tslib\";\r\nimport { Inject, Optional } from '@angular/core';\r\nimport * as lodash from 'lodash';\r\nimport { LoginDialogComponent } from '../../components/login-dialog';\r\nimport { DEFAULT_AUTH_MAP, DEFAULT_AUTHENTICATION_ENTRY_POINT, DEFAULT_CREDENTIALS_MAP, EVENT_SERVICE, EVENTS } from '../../constants';\r\nimport { IAuthenticationManagerService, IAuthenticationService, IModalService, ISettingsService, ISharedDataService, IStorageService } from '../../interfaces';\r\nimport { functionsUtils } from '../../utils';\r\nimport { ITranslationsFetchService } from '../translations';\r\nimport { SSOAuthenticationHelper } from './sso-authentication.helper';\r\nlet AuthenticationService = class AuthenticationService extends IAuthenticationService {\r\n    constructor(translationsFetchService, modalService, sharedDataService, storageService, eventService, ssoAuthenticationHelper, settingsService, authenticationManager) {\r\n        super();\r\n        this.translationsFetchService = translationsFetchService;\r\n        this.modalService = modalService;\r\n        this.sharedDataService = sharedDataService;\r\n        this.storageService = storageService;\r\n        this.eventService = eventService;\r\n        this.ssoAuthenticationHelper = ssoAuthenticationHelper;\r\n        this.settingsService = settingsService;\r\n        this.authenticationManager = authenticationManager;\r\n    }\r\n    filterEntryPoints(resource) {\r\n        return this.sharedDataService.get('authenticationMap').then((authenticationMap) => functionsUtils\r\n            .convertToArray(Object.assign(Object.assign({}, (authenticationMap || {})), DEFAULT_AUTH_MAP))\r\n            .filter((entry) => new RegExp(entry.key, 'g').test(resource))\r\n            .map((element) => element.value));\r\n    }\r\n    isAuthEntryPoint(resource) {\r\n        return this.sharedDataService.get('authenticationMap').then((authenticationMap) => {\r\n            const authEntryPoints = functionsUtils\r\n                .convertToArray(authenticationMap || {})\r\n                .map((element) => element.value);\r\n            return (authEntryPoints.indexOf(resource) > -1 ||\r\n                resource === DEFAULT_AUTHENTICATION_ENTRY_POINT);\r\n        });\r\n    }\r\n    authenticate(resource) {\r\n        return this._findLoginData(resource).then((loginData) => this._launchAuth(loginData).then((modalFeedback) => {\r\n            Promise.resolve(this.eventService.publish(EVENTS.AUTHORIZATION_SUCCESS, {\r\n                userHasChanged: modalFeedback.userHasChanged\r\n            })).then(() => {\r\n                if (modalFeedback.userHasChanged) {\r\n                    this.eventService.publish(EVENTS.USER_HAS_CHANGED);\r\n                }\r\n                /**\r\n                 * We only need to reload when the user has changed and all authentication forms were closed.\r\n                 * There can be many authentication forms if some modules use different (from default one) end points.\r\n                 */\r\n                const reauthInProcess = lodash\r\n                    .values(this.reauthInProgress)\r\n                    .some((inProcess) => inProcess);\r\n                if (modalFeedback.userHasChanged &&\r\n                    !reauthInProcess &&\r\n                    this.authenticationManager &&\r\n                    this.authenticationManager.onUserHasChanged) {\r\n                    this.authenticationManager.onUserHasChanged();\r\n                }\r\n            });\r\n            this.reauthInProgress[loginData.authURI] = false;\r\n        }));\r\n    }\r\n    logout() {\r\n        // First, indicate the services that SmartEdit is logging out. This should give them the opportunity to clean up.\r\n        // NOTE: This is not synchronous since some clean-up might be lengthy, and logging out should be fast.\r\n        return this.eventService.publish(EVENTS.LOGOUT).then(() => {\r\n            this.storageService.removeAllAuthTokens();\r\n            if (this.ssoAuthenticationHelper.isAutoSSOMain()) {\r\n                this.ssoAuthenticationHelper.logout();\r\n            }\r\n            else if (this.authenticationManager && this.authenticationManager.onLogout) {\r\n                this.authenticationManager.onLogout();\r\n            }\r\n        });\r\n    }\r\n    isReAuthInProgress(entryPoint) {\r\n        return Promise.resolve(this.reauthInProgress[entryPoint] === true);\r\n    }\r\n    setReAuthInProgress(entryPoint) {\r\n        this.reauthInProgress[entryPoint] = true;\r\n        return Promise.resolve();\r\n    }\r\n    isAuthenticated(url) {\r\n        return this.filterEntryPoints(url).then((entryPoints) => {\r\n            const authURI = entryPoints && entryPoints[0];\r\n            return Promise.resolve(this.storageService.getAuthToken(authURI)).then((authToken) => !!authToken);\r\n        });\r\n    }\r\n    /*\r\n     * will try determine first relevant authentication entry point from authenticationMap and retrieve potential client credentials to be added on top of user credentials\r\n     */\r\n    _findLoginData(resource) {\r\n        return this.filterEntryPoints(resource).then((entryPoints) => Promise.resolve(this.sharedDataService.get('credentialsMap').then((credentialsMap) => {\r\n            const map = Object.assign(Object.assign({}, (credentialsMap || {})), DEFAULT_CREDENTIALS_MAP);\r\n            const authURI = entryPoints[0];\r\n            return {\r\n                authURI,\r\n                clientCredentials: map[authURI]\r\n            };\r\n        })));\r\n    }\r\n    _launchAuth(loginData) {\r\n        return this.translationsFetchService\r\n            .waitToBeReady()\r\n            .then(() => Promise.all([\r\n            this.storageService.isInitialized(),\r\n            this.settingsService.getBoolean('smartedit.sso.enabled')\r\n        ]))\r\n            .then(([isFullScreen, ssoEnabled]) => {\r\n            const modalRef = this.modalService.open({\r\n                component: LoginDialogComponent,\r\n                data: Object.assign(Object.assign({}, loginData), { isFullScreen,\r\n                    ssoEnabled }),\r\n                config: {\r\n                    modalPanelClass: 'su-login-dialog-container',\r\n                    hasBackdrop: false\r\n                }\r\n            });\r\n            return new Promise((resolve, reject) => {\r\n                modalRef.afterClosed.subscribe(resolve, reject);\r\n            });\r\n        });\r\n    }\r\n};\r\nAuthenticationService = __decorate([\r\n    __param(4, Inject(EVENT_SERVICE)),\r\n    __param(7, Optional()),\r\n    __metadata(\"design:paramtypes\", [ITranslationsFetchService,\r\n        IModalService,\r\n        ISharedDataService,\r\n        IStorageService, Object, SSOAuthenticationHelper,\r\n        ISettingsService,\r\n        IAuthenticationManagerService])\r\n], AuthenticationService);\r\nexport { AuthenticationService };\r\n//# sourceMappingURL=authentication.service.js.map","references":["/home/wadmin/Documents/cloud-commerce-sample-setup-update-2211/core-customize/hybris/bin/modules/smartedit/smartedittools/common/temp/node_modules/.pnpm/@angular+core@8.2.14_rxjs@6.5.4+zone.js@0.9.1/node_modules/@angular/core/core.d.ts","/home/wadmin/Documents/cloud-commerce-sample-setup-update-2211/core-customize/hybris/bin/modules/smartedit/smartedittools/common/temp/node_modules/.pnpm/@types+lodash@4.14.159/node_modules/@types/lodash/ts3.1/index.d.ts","/home/wadmin/Documents/cloud-commerce-sample-setup-update-2211/core-customize/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/components/login-dialog/index.ts","/home/wadmin/Documents/cloud-commerce-sample-setup-update-2211/core-customize/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/constants.ts","/home/wadmin/Documents/cloud-commerce-sample-setup-update-2211/core-customize/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/dtos/index.ts","/home/wadmin/Documents/cloud-commerce-sample-setup-update-2211/core-customize/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/interfaces/index.ts","/home/wadmin/Documents/cloud-commerce-sample-setup-update-2211/core-customize/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/utils/index.ts","/home/wadmin/Documents/cloud-commerce-sample-setup-update-2211/core-customize/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/services/translations/index.ts","/home/wadmin/Documents/cloud-commerce-sample-setup-update-2211/core-customize/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/services/authentication/sso-authentication.helper.ts"],"map":"{\"version\":3,\"file\":\"authentication.service.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../../src/services/authentication/authentication.service.ts\"],\"names\":[],\"mappings\":\"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\"}","dts":{"name":"/home/wadmin/Documents/cloud-commerce-sample-setup-update-2211/core-customize/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/node_modules/.cache/rollup-plugin-typescript2/placeholder/services/authentication/authentication.service.d.ts","writeByteOrderMark":false,"text":"/**\r\n * Copyright (c) 2019 SAP SE or an SAP affiliate company. All rights reserved.\r\n * @module smartutils\r\n */\r\nimport { IAuthenticationManagerService, IAuthenticationService, ICredentialsMapRecord, IEventService, ILoginData, IModalService, ISettingsService, ISharedDataService, IStorageService } from '../../interfaces';\r\nimport { ITranslationsFetchService } from '../translations';\r\nimport { SSOAuthenticationHelper } from './sso-authentication.helper';\r\nexport interface ICredentialsMap {\r\n    [entryPoint: string]: ICredentialsMapRecord;\r\n}\r\nexport interface IAuthMap {\r\n    [entryPoint: string]: string;\r\n}\r\nexport declare class AuthenticationService extends IAuthenticationService {\r\n    protected translationsFetchService: ITranslationsFetchService;\r\n    protected modalService: IModalService;\r\n    protected sharedDataService: ISharedDataService;\r\n    protected storageService: IStorageService;\r\n    protected eventService: IEventService;\r\n    protected ssoAuthenticationHelper: SSOAuthenticationHelper;\r\n    protected settingsService: ISettingsService;\r\n    protected authenticationManager: IAuthenticationManagerService;\r\n    constructor(translationsFetchService: ITranslationsFetchService, modalService: IModalService, sharedDataService: ISharedDataService, storageService: IStorageService, eventService: IEventService, ssoAuthenticationHelper: SSOAuthenticationHelper, settingsService: ISettingsService, authenticationManager: IAuthenticationManagerService);\r\n    filterEntryPoints(resource: string): Promise<string[]>;\r\n    isAuthEntryPoint(resource: string): Promise<boolean>;\r\n    authenticate(resource: string): Promise<void>;\r\n    logout(): Promise<void>;\r\n    isReAuthInProgress(entryPoint: string): Promise<boolean>;\r\n    setReAuthInProgress(entryPoint: string): Promise<void>;\r\n    isAuthenticated(url: string): Promise<boolean>;\r\n    protected _findLoginData(resource: string): Promise<ILoginData>;\r\n    protected _launchAuth(loginData: ILoginData): Promise<any>;\r\n}\r\n"}}
