{"code":"var CacheEngine_1;\r\nimport { __decorate, __metadata } from \"tslib\";\r\n/*\r\n * Copyright (c) 2022 SAP SE or an SAP affiliate company. All rights reserved.\r\n */\r\n/**\r\n * Copyright (c) 2019 SAP SE or an SAP affiliate company. All rights reserved.\r\n * @module smartutils\r\n */\r\nimport { Injectable } from '@angular/core';\r\nimport { PromiseUtils, WindowUtils } from '../../../utils';\r\nimport { LogService } from '../../log.service';\r\n/** @internal */\r\nlet CacheEngine = CacheEngine_1 = class CacheEngine {\r\n    constructor(windowUtils, promiseUtils, logService) {\r\n        this.windowUtils = windowUtils;\r\n        this.promiseUtils = promiseUtils;\r\n        this.logService = logService;\r\n        this.cachedItemsRegistry = [];\r\n        this.startBackgroundMonitoringJob();\r\n    }\r\n    addItem(item, cacheTiming, refresh) {\r\n        if (this.getItemIndex(item) === -1) {\r\n            this.cachedItemsRegistry.push({\r\n                item,\r\n                cacheTiming,\r\n                refresh,\r\n                completed: false,\r\n                processing: false,\r\n                defer: this.promiseUtils.defer()\r\n            });\r\n        }\r\n        else {\r\n            this.logService.warn(`CacheEngine - item already exist for id: ${item.id}`);\r\n        }\r\n    }\r\n    getItemById(id) {\r\n        const match = this.cachedItemsRegistry.find((obj) => obj.item.id === id);\r\n        return match ? match.item : null;\r\n    }\r\n    handle(item) {\r\n        const obj = this.cachedItemsRegistry[this.getItemIndex(item)];\r\n        if (obj.completed && !this.hasExpired(item)) {\r\n            obj.defer.resolve(item.cache);\r\n        }\r\n        else if (!obj.processing) {\r\n            obj.processing = true;\r\n            this.refreshCache(obj);\r\n        }\r\n        return obj.defer.promise;\r\n    }\r\n    evict(...tags) {\r\n        tags.forEach((tag) => {\r\n            this.cachedItemsRegistry\r\n                .filter((obj) => obj.item.evictionTags.indexOf(tag) > -1)\r\n                .forEach((obj) => this.cachedItemsRegistry.splice(this.getItemIndex(obj.item), 1));\r\n        });\r\n    }\r\n    // regularly go though cache data and call prebound methods to refresh data when needed.\r\n    startBackgroundMonitoringJob() {\r\n        this.windowUtils.runIntervalOutsideAngular(() => Promise.all(this.cachedItemsRegistry\r\n            .filter((obj) => this.needRefresh(obj.item))\r\n            .map((obj) => this.refreshCache(obj))), CacheEngine_1.BACKGROUND_REFRESH_INTERVAL);\r\n    }\r\n    refreshCache(obj) {\r\n        return obj.refresh().then((value) => {\r\n            // TODO: read value.metadata to refresh expiry/refresh ages.\r\n            obj.cacheTiming.setAge(obj.item);\r\n            obj.item.cache = value;\r\n            obj.item.timestamp = new Date().getTime();\r\n            obj.completed = true;\r\n            obj.processing = false;\r\n            obj.defer.resolve(value);\r\n        }, (e) => {\r\n            this.logService.debug(`CacheEngine - unable to refresh cache for id: ${obj.item.id}`, e);\r\n            delete obj.item.cache;\r\n            obj.defer.reject(e);\r\n        });\r\n    }\r\n    hasExpired(item) {\r\n        return item.timestamp + item.expirationAge <= new Date().getTime();\r\n    }\r\n    needRefresh(item) {\r\n        return item.timestamp + item.refreshAge <= new Date().getTime();\r\n    }\r\n    getItemIndex(item) {\r\n        return this.cachedItemsRegistry.findIndex((o) => o.item.id === item.id);\r\n    }\r\n};\r\nCacheEngine.BACKGROUND_REFRESH_INTERVAL = 10000;\r\nCacheEngine = CacheEngine_1 = __decorate([\r\n    Injectable(),\r\n    __metadata(\"design:paramtypes\", [WindowUtils,\r\n        PromiseUtils,\r\n        LogService])\r\n], CacheEngine);\r\nexport { CacheEngine };\r\n//# sourceMappingURL=cache-engine.js.map","references":["/home/wadmin/Documents/cloud-commerce-sample-setup-update-2211/core-customize/hybris/bin/modules/smartedit/smartedittools/common/temp/node_modules/.pnpm/@angular+core@8.2.14_rxjs@6.5.4+zone.js@0.9.1/node_modules/@angular/core/core.d.ts","/home/wadmin/Documents/cloud-commerce-sample-setup-update-2211/core-customize/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/utils/index.ts","/home/wadmin/Documents/cloud-commerce-sample-setup-update-2211/core-customize/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/services/log.service.ts","/home/wadmin/Documents/cloud-commerce-sample-setup-update-2211/core-customize/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/services/cache/engine/interfaces/index.ts"],"map":"{\"version\":3,\"file\":\"cache-engine.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../../../src/services/cache/engine/cache-engine.ts\"],\"names\":[],\"mappings\":\"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\"}","dts":{"name":"/home/wadmin/Documents/cloud-commerce-sample-setup-update-2211/core-customize/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/node_modules/.cache/rollup-plugin-typescript2/placeholder/services/cache/engine/cache-engine.d.ts","writeByteOrderMark":false,"text":"import { Deferred, PromiseUtils, WindowUtils } from '../../../utils';\r\nimport { LogService } from '../../log.service';\r\nimport { ICacheItem, ICacheTiming } from './interfaces';\r\n/** @internal */\r\nexport interface ICacheItemRegistry {\r\n    item: ICacheItem<any>;\r\n    cacheTiming: ICacheTiming;\r\n    completed: boolean;\r\n    processing: boolean;\r\n    defer: Deferred<any>;\r\n    refresh<T>(): Promise<T>;\r\n}\r\n/** @internal */\r\nexport declare class CacheEngine {\r\n    private windowUtils;\r\n    private promiseUtils;\r\n    private logService;\r\n    static readonly BACKGROUND_REFRESH_INTERVAL: number;\r\n    private cachedItemsRegistry;\r\n    constructor(windowUtils: WindowUtils, promiseUtils: PromiseUtils, logService: LogService);\r\n    addItem(item: ICacheItem<any>, cacheTiming: ICacheTiming, refresh: <T>() => Promise<T>): void;\r\n    getItemById(id: string): ICacheItem<any> | null;\r\n    handle<T>(item: ICacheItem<any>): Promise<T>;\r\n    evict(...tags: string[]): void;\r\n    protected startBackgroundMonitoringJob(): void;\r\n    protected refreshCache<T>(obj: ICacheItemRegistry): Promise<T | void>;\r\n    private hasExpired;\r\n    private needRefresh;\r\n    private getItemIndex;\r\n}\r\n"}}
