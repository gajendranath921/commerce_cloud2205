{"code":"import { __decorate, __metadata, __param } from \"tslib\";\r\n/*\r\n * Copyright (c) 2022 SAP SE or an SAP affiliate company. All rights reserved.\r\n */\r\n/**\r\n * Copyright (c) 2019 SAP SE or an SAP affiliate company. All rights reserved.\r\n * @module smartutils\r\n */\r\nimport { Inject, Injectable } from '@angular/core';\r\nimport * as lodash from 'lodash';\r\nimport { EVENT_SERVICE } from '../../constants';\r\nimport { FunctionsUtils, StringUtils } from '../../utils';\r\nimport { LogService } from '../log.service';\r\nimport { CacheEngine, DefaultCacheTiming } from './engine';\r\n/**\r\n * @ngdoc service\r\n * @name @smartutils.services:CacheService\r\n * @description\r\n * Service to which the {@link @smartutils.object:@Cached @Cached} and {@link @smartutils.object:@InvalidateCache @InvalidateCache} annotations delegate to perform service method level caching.\r\n * It is not handled explicitly except for its evict method.\r\n */\r\nlet CacheService = class CacheService {\r\n    constructor(logService, stringUtils, functionsUtils, eventService, cacheEngine) {\r\n        this.logService = logService;\r\n        this.stringUtils = stringUtils;\r\n        this.functionsUtils = functionsUtils;\r\n        this.eventService = eventService;\r\n        this.cacheEngine = cacheEngine;\r\n        this.predicatesRegistry = [];\r\n        this.eventListeners = [];\r\n        this.defaultCacheTiming = new DefaultCacheTiming(24 * 60 * 60 * 1000, 12 * 60 * 60 * 1000);\r\n    }\r\n    /**\r\n     * @ngdoc method\r\n     * @name @smartutils.services:CacheService#register\r\n     * @methodOf @smartutils.services:CacheService\r\n     *\r\n     * @description\r\n     * Register a new predicate with it's associated cacheTiming.\r\n     * Each time the @Cache annotation is handled, the CacheService try to find a matching cacheTiming for the given cacheActions.\r\n     *\r\n     * @param {ICachePredicate} test This function takes the cacheActions {@link @smartutils.object:CacheAction CacheAction} argument, and must return a Boolean that is true if the given cacheActions match the predicate.\r\n     * @param {ICacheTiming} cacheTiming This function is used to call setAge(item: ICacheItem<any>) on the cached item.\r\n     *\r\n     * @return {CacheService} CacheService The CacheService instance.\r\n     *\r\n     * @example\r\n     * ```ts\r\n     * export class CustomCacheTiming implements ICacheTiming {\r\n     * \tprivate expirationAge: number;\r\n     * \tprivate refreshAge: number;\r\n     *  constructor(expirationAge: number, refreshAge: number) {\r\n     * \t\t// The cached response is discarded if it is older than the expiration age.\r\n     * \t\tthis.expirationAge = expirationAge;\r\n     * \t\t// maximum age for the cached response to be considered \"fresh.\"\r\n     * \t\tthis.refreshAge = refreshAge;\r\n     * \t}\r\n     * \tsetAge(item: ICacheItem<any>): void {\r\n     * \t\titem.expirationAge = this.expirationAge;\r\n     * \t\titem.refreshAge = this.refreshAge;\r\n     * \t}\r\n     * \t};\r\n     * \tconst customCacheTiming = new CustomCacheTiming(30 * 60000, 15 * 60000);\r\n     * \tconst customContentPredicate: ICachePredicate = (cacheActions: CacheAction[]) => {\r\n     * \t\treturn cacheActions.find((cacheAction) => cacheAction.name === 'CUSTOM_TAG') !== null;\r\n     * \t};\r\n     * this.register(customContentPredicate, customCacheTiming);\r\n     * ```\r\n     */\r\n    register(test, cacheTiming) {\r\n        this.predicatesRegistry.unshift({\r\n            test,\r\n            cacheTiming\r\n        });\r\n        return this;\r\n    }\r\n    /**\r\n     * public method but only meant to be used by @Cache annotation\r\n     */\r\n    handle(service, methodName, preboundMethod, invocationArguments, cacheActions, tags) {\r\n        const constructorName = this.functionsUtils.getInstanceConstructorName(service);\r\n        const cachedItemId = window.btoa(constructorName + methodName) +\r\n            this.stringUtils.encode(invocationArguments);\r\n        const _item = this.cacheEngine.getItemById(cachedItemId);\r\n        let item;\r\n        if (!_item) {\r\n            const partialItem = _item || {\r\n                id: cachedItemId,\r\n                timestamp: new Date().getTime(),\r\n                evictionTags: this.collectEventNamesFromTags(tags),\r\n                cache: null\r\n            };\r\n            const cacheTiming = this.findCacheTimingByCacheActions(cacheActions);\r\n            if (!cacheTiming) {\r\n                throw new Error('CacheService::handle - No predicate match.');\r\n            }\r\n            item = cacheTiming.setAge(partialItem);\r\n            this.cacheEngine.addItem(item, cacheTiming, preboundMethod.bind(undefined, ...Array.prototype.slice.call(invocationArguments)));\r\n            this.listenForEvictionByTags(tags);\r\n        }\r\n        else {\r\n            item = _item;\r\n        }\r\n        return this.cacheEngine.handle(item);\r\n    }\r\n    /**\r\n     * @ngdoc method\r\n     * @name @smartutils.services:CacheService#evict\r\n     * @methodOf  @smartutils.services:CacheService\r\n     * @description\r\n     * Will evict the entire cache of all methods of all services referencing either directly or indirectly the given {@link @smartutils.object:EvictionTag EvictionTags}\r\n     * @param {...EvictionTag[]} evictionTags the {@link @smartutils.object:EvictionTag EvictionTags}\r\n     */\r\n    evict(...evictionTags) {\r\n        const tags = this.collectEventNamesFromTags(evictionTags);\r\n        this.cacheEngine.evict(...tags);\r\n        tags.forEach((tag) => this.eventService.publish(tag));\r\n    }\r\n    listenForEvictionByTags(tags) {\r\n        this.collectEventNamesFromTags(tags)\r\n            .filter((eventId) => this.eventListeners.indexOf(eventId) === -1)\r\n            .forEach((eventId) => {\r\n            this.logService.debug(`registering event listener ${eventId}`);\r\n            this.eventListeners.push(eventId);\r\n            this.eventService.subscribe(eventId, (evt, data) => {\r\n                this.logService.debug(`cleaning cache on event ${eventId}`);\r\n                this.cacheEngine.evict(eventId);\r\n                return Promise.resolve({});\r\n            });\r\n        });\r\n    }\r\n    collectEventNamesFromTags(tags) {\r\n        if (tags && tags.length) {\r\n            return lodash.union(...tags.map((t) => this.collectEventNamesFromTag(t)));\r\n        }\r\n        else {\r\n            return [];\r\n        }\r\n    }\r\n    collectEventNamesFromTag(tag) {\r\n        return lodash.union([tag.event], ...(tag.relatedTags ? tag.relatedTags.map((t) => this.collectEventNamesFromTag(t)) : []));\r\n    }\r\n    findCacheTimingByCacheActions(cacheActions) {\r\n        const predicate = this.predicatesRegistry.find((cacheTimingPredicate) => cacheTimingPredicate.test(cacheActions));\r\n        return predicate ? predicate.cacheTiming : this.defaultCacheTiming;\r\n    }\r\n};\r\nCacheService = __decorate([\r\n    Injectable(),\r\n    __param(3, Inject(EVENT_SERVICE)),\r\n    __metadata(\"design:paramtypes\", [LogService,\r\n        StringUtils,\r\n        FunctionsUtils, Object, CacheEngine])\r\n], CacheService);\r\nexport { CacheService };\r\n//# sourceMappingURL=cache.service.js.map","references":["/home/wadmin/Documents/cloud-commerce-sample-setup-update-2211/core-customize/hybris/bin/modules/smartedit/smartedittools/common/temp/node_modules/.pnpm/@angular+core@8.2.14_rxjs@6.5.4+zone.js@0.9.1/node_modules/@angular/core/core.d.ts","/home/wadmin/Documents/cloud-commerce-sample-setup-update-2211/core-customize/hybris/bin/modules/smartedit/smartedittools/common/temp/node_modules/.pnpm/@types+lodash@4.14.159/node_modules/@types/lodash/ts3.1/index.d.ts","/home/wadmin/Documents/cloud-commerce-sample-setup-update-2211/core-customize/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/constants.ts","/home/wadmin/Documents/cloud-commerce-sample-setup-update-2211/core-customize/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/dtos/index.ts","/home/wadmin/Documents/cloud-commerce-sample-setup-update-2211/core-customize/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/interfaces/index.ts","/home/wadmin/Documents/cloud-commerce-sample-setup-update-2211/core-customize/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/utils/index.ts","/home/wadmin/Documents/cloud-commerce-sample-setup-update-2211/core-customize/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/services/log.service.ts","/home/wadmin/Documents/cloud-commerce-sample-setup-update-2211/core-customize/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/services/cache/cache-action.ts","/home/wadmin/Documents/cloud-commerce-sample-setup-update-2211/core-customize/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/services/cache/engine/index.ts","/home/wadmin/Documents/cloud-commerce-sample-setup-update-2211/core-customize/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/services/cache/eviction-tag.ts"],"map":"{\"version\":3,\"file\":\"cache.service.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../../src/services/cache/cache.service.ts\"],\"names\":[],\"mappings\":\"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\"}","dts":{"name":"/home/wadmin/Documents/cloud-commerce-sample-setup-update-2211/core-customize/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/node_modules/.cache/rollup-plugin-typescript2/placeholder/services/cache/cache.service.d.ts","writeByteOrderMark":false,"text":"import { IEventService } from '../../interfaces';\r\nimport { FunctionsUtils, StringUtils } from '../../utils';\r\nimport { LogService } from '../log.service';\r\nimport { CacheAction } from './cache-action';\r\nimport { CacheEngine, ICacheTiming, IMetadata } from './engine';\r\nimport { EvictionTag } from './eviction-tag';\r\nexport declare type ICachePredicate = (cacheActions: CacheAction[]) => boolean;\r\n/**\r\n * @ngdoc service\r\n * @name @smartutils.services:CacheService\r\n * @description\r\n * Service to which the {@link @smartutils.object:@Cached @Cached} and {@link @smartutils.object:@InvalidateCache @InvalidateCache} annotations delegate to perform service method level caching.\r\n * It is not handled explicitly except for its evict method.\r\n */\r\nexport declare class CacheService {\r\n    private logService;\r\n    private stringUtils;\r\n    private functionsUtils;\r\n    private eventService;\r\n    private cacheEngine;\r\n    private predicatesRegistry;\r\n    private eventListeners;\r\n    private defaultCacheTiming;\r\n    constructor(logService: LogService, stringUtils: StringUtils, functionsUtils: FunctionsUtils, eventService: IEventService, cacheEngine: CacheEngine);\r\n    /**\r\n     * @ngdoc method\r\n     * @name @smartutils.services:CacheService#register\r\n     * @methodOf @smartutils.services:CacheService\r\n     *\r\n     * @description\r\n     * Register a new predicate with it's associated cacheTiming.\r\n     * Each time the @Cache annotation is handled, the CacheService try to find a matching cacheTiming for the given cacheActions.\r\n     *\r\n     * @param {ICachePredicate} test This function takes the cacheActions {@link @smartutils.object:CacheAction CacheAction} argument, and must return a Boolean that is true if the given cacheActions match the predicate.\r\n     * @param {ICacheTiming} cacheTiming This function is used to call setAge(item: ICacheItem<any>) on the cached item.\r\n     *\r\n     * @return {CacheService} CacheService The CacheService instance.\r\n     *\r\n     * @example\r\n     * ```ts\r\n     * export class CustomCacheTiming implements ICacheTiming {\r\n     * \tprivate expirationAge: number;\r\n     * \tprivate refreshAge: number;\r\n     *  constructor(expirationAge: number, refreshAge: number) {\r\n     * \t\t// The cached response is discarded if it is older than the expiration age.\r\n     * \t\tthis.expirationAge = expirationAge;\r\n     * \t\t// maximum age for the cached response to be considered \"fresh.\"\r\n     * \t\tthis.refreshAge = refreshAge;\r\n     * \t}\r\n     * \tsetAge(item: ICacheItem<any>): void {\r\n     * \t\titem.expirationAge = this.expirationAge;\r\n     * \t\titem.refreshAge = this.refreshAge;\r\n     * \t}\r\n     * \t};\r\n     * \tconst customCacheTiming = new CustomCacheTiming(30 * 60000, 15 * 60000);\r\n     * \tconst customContentPredicate: ICachePredicate = (cacheActions: CacheAction[]) => {\r\n     * \t\treturn cacheActions.find((cacheAction) => cacheAction.name === 'CUSTOM_TAG') !== null;\r\n     * \t};\r\n     * this.register(customContentPredicate, customCacheTiming);\r\n     * ```\r\n     */\r\n    register(test: ICachePredicate, cacheTiming: ICacheTiming): CacheService;\r\n    /**\r\n     * public method but only meant to be used by @Cache annotation\r\n     */\r\n    handle<T extends IMetadata>(service: any, methodName: string, preboundMethod: (...args: any[]) => Promise<T>, invocationArguments: any[], cacheActions: CacheAction[], tags: EvictionTag[]): Promise<T>;\r\n    /**\r\n     * @ngdoc method\r\n     * @name @smartutils.services:CacheService#evict\r\n     * @methodOf  @smartutils.services:CacheService\r\n     * @description\r\n     * Will evict the entire cache of all methods of all services referencing either directly or indirectly the given {@link @smartutils.object:EvictionTag EvictionTags}\r\n     * @param {...EvictionTag[]} evictionTags the {@link @smartutils.object:EvictionTag EvictionTags}\r\n     */\r\n    evict(...evictionTags: EvictionTag[]): void;\r\n    protected listenForEvictionByTags(tags: EvictionTag[]): void;\r\n    protected collectEventNamesFromTags(tags: EvictionTag[]): string[];\r\n    protected collectEventNamesFromTag(tag: EvictionTag): string[];\r\n    protected findCacheTimingByCacheActions(cacheActions: CacheAction[]): ICacheTiming | null;\r\n}\r\n"}}
