{"code":"import { __decorate, __metadata, __param } from \"tslib\";\r\n/*\r\n * Copyright (c) 2022 SAP SE or an SAP affiliate company. All rights reserved.\r\n */\r\n/**\r\n * Copyright (c) 2019 SAP SE or an SAP affiliate company. All rights reserved.\r\n * @module smartutils\r\n */\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { Inject, Injectable } from '@angular/core';\r\nimport { EVENT_SERVICE, REAUTH_STARTED, WHO_AM_I_RESOURCE_URI_TOKEN } from '../../../constants';\r\nimport { IAuthenticationService } from '../../../interfaces';\r\nimport { HttpUtils, PromiseUtils } from '../../../utils';\r\n// map used by HttpAuthInterceptor to avoid replay identical requests being held because of 401\r\nexport const GET_REQUESTS_ON_HOLD_MAP = {};\r\n/**\r\n * @ngdoc service\r\n * @name @smartutils.services:unauthorizedErrorInterceptor\r\n * @description\r\n * Used for HTTP error code 401 (Forbidden). It will display the login modal.\r\n */\r\nlet UnauthorizedErrorInterceptor = class UnauthorizedErrorInterceptor {\r\n    constructor(httpClient, authenticationService, promiseUtils, httpUtils, WHO_AM_I_RESOURCE_URI, eventService) {\r\n        this.httpClient = httpClient;\r\n        this.authenticationService = authenticationService;\r\n        this.promiseUtils = promiseUtils;\r\n        this.httpUtils = httpUtils;\r\n        this.eventService = eventService;\r\n        this.promisesToResolve = {}; // key: auth entry point, value: array of deferred\r\n        this.rejectedUrls = [/authenticate/];\r\n        this.rejectedUrls.push(WHO_AM_I_RESOURCE_URI);\r\n    }\r\n    predicate(request, response) {\r\n        return (response.status === 401 &&\r\n            (request.url\r\n                ? this.httpUtils.isCRUDRequest(request, response) &&\r\n                    this.isUrlNotRejected(request.url)\r\n                : true));\r\n    }\r\n    responseError(request, response) {\r\n        const deferred = this.promiseUtils.defer();\r\n        const deferredPromise = deferred.promise.then(() => this.httpClient.request(request).toPromise());\r\n        this.authenticationService.isAuthEntryPoint(request.url).then((isAuthEntryPoint) => {\r\n            if (!isAuthEntryPoint) {\r\n                this.authenticationService\r\n                    .filterEntryPoints(request.url)\r\n                    .then((entryPoints) => {\r\n                    const entryPoint = entryPoints[0];\r\n                    this.promisesToResolve[entryPoint] =\r\n                        this.promisesToResolve[entryPoint] || [];\r\n                    this.promisesToResolve[entryPoint].push({\r\n                        requestIdentifier: request.url,\r\n                        deferred\r\n                    });\r\n                    if (this.httpUtils.isGET(request)) {\r\n                        GET_REQUESTS_ON_HOLD_MAP[request.url] = deferredPromise;\r\n                    }\r\n                    this.authenticationService\r\n                        .isReAuthInProgress(entryPoint)\r\n                        .then((isReAuthInProgress) => {\r\n                        if (!isReAuthInProgress) {\r\n                            this.authenticationService\r\n                                .setReAuthInProgress(entryPoint)\r\n                                .then(() => {\r\n                                const promisesToResolve = this.promisesToResolve;\r\n                                this.eventService.publish(REAUTH_STARTED);\r\n                                this.authenticationService\r\n                                    .authenticate(request.url)\r\n                                    .then(function () {\r\n                                    promisesToResolve[this].forEach((record) => {\r\n                                        delete GET_REQUESTS_ON_HOLD_MAP[record.requestIdentifier];\r\n                                        record.deferred.resolve();\r\n                                    });\r\n                                    promisesToResolve[this] = [];\r\n                                }.bind(entryPoint), function () {\r\n                                    promisesToResolve[this].forEach((record) => {\r\n                                        delete GET_REQUESTS_ON_HOLD_MAP[record.requestIdentifier];\r\n                                        record.deferred.reject();\r\n                                    });\r\n                                    promisesToResolve[this] = [];\r\n                                }.bind(entryPoint));\r\n                            });\r\n                        }\r\n                    });\r\n                });\r\n            }\r\n            else {\r\n                deferred.reject(response);\r\n            }\r\n        });\r\n        return deferredPromise;\r\n    }\r\n    isUrlNotRejected(url) {\r\n        return !this.rejectedUrls.some((rejectedUrl) => typeof rejectedUrl === 'string' ? url.indexOf(rejectedUrl) === 0 : rejectedUrl.test(url));\r\n    }\r\n};\r\nUnauthorizedErrorInterceptor = __decorate([\r\n    Injectable(),\r\n    __param(4, Inject(WHO_AM_I_RESOURCE_URI_TOKEN)),\r\n    __param(5, Inject(EVENT_SERVICE)),\r\n    __metadata(\"design:paramtypes\", [HttpClient,\r\n        IAuthenticationService,\r\n        PromiseUtils,\r\n        HttpUtils, String, Object])\r\n], UnauthorizedErrorInterceptor);\r\nexport { UnauthorizedErrorInterceptor };\r\n//# sourceMappingURL=unauthorized-error.interceptor.js.map","references":["/home/wadmin/Documents/cloud-commerce-sample-setup-update-2211/core-customize/hybris/bin/modules/smartedit/smartedittools/common/temp/node_modules/.pnpm/@angular+common@8.2.14_@angular+core@8.2.14+rxjs@6.5.4/node_modules/@angular/common/http.d.ts","/home/wadmin/Documents/cloud-commerce-sample-setup-update-2211/core-customize/hybris/bin/modules/smartedit/smartedittools/common/temp/node_modules/.pnpm/@angular+core@8.2.14_rxjs@6.5.4+zone.js@0.9.1/node_modules/@angular/core/core.d.ts","/home/wadmin/Documents/cloud-commerce-sample-setup-update-2211/core-customize/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/constants.ts","/home/wadmin/Documents/cloud-commerce-sample-setup-update-2211/core-customize/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/dtos/index.ts","/home/wadmin/Documents/cloud-commerce-sample-setup-update-2211/core-customize/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/interfaces/index.ts","/home/wadmin/Documents/cloud-commerce-sample-setup-update-2211/core-customize/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/utils/index.ts","/home/wadmin/Documents/cloud-commerce-sample-setup-update-2211/core-customize/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/services/interceptors/i-http-error.interceptor.ts"],"map":"{\"version\":3,\"file\":\"unauthorized-error.interceptor.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../../../src/services/interceptors/errors/unauthorized-error.interceptor.ts\"],\"names\":[],\"mappings\":\"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\"}","dts":{"name":"/home/wadmin/Documents/cloud-commerce-sample-setup-update-2211/core-customize/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/node_modules/.cache/rollup-plugin-typescript2/placeholder/services/interceptors/errors/unauthorized-error.interceptor.d.ts","writeByteOrderMark":false,"text":"/**\r\n * Copyright (c) 2019 SAP SE or an SAP affiliate company. All rights reserved.\r\n * @module smartutils\r\n */\r\nimport { HttpClient, HttpErrorResponse, HttpEvent, HttpRequest } from '@angular/common/http';\r\nimport { TypedMap } from '../../../dtos';\r\nimport { IAuthenticationService, IEventService } from '../../../interfaces';\r\nimport { HttpUtils, PromiseUtils } from '../../../utils';\r\nimport { IHttpErrorInterceptor } from '../i-http-error.interceptor';\r\nexport declare const GET_REQUESTS_ON_HOLD_MAP: TypedMap<Promise<HttpEvent<any>>>;\r\n/**\r\n * @ngdoc service\r\n * @name @smartutils.services:unauthorizedErrorInterceptor\r\n * @description\r\n * Used for HTTP error code 401 (Forbidden). It will display the login modal.\r\n */\r\nexport declare class UnauthorizedErrorInterceptor<T = any> implements IHttpErrorInterceptor<T> {\r\n    private httpClient;\r\n    private authenticationService;\r\n    private promiseUtils;\r\n    private httpUtils;\r\n    private eventService;\r\n    private promisesToResolve;\r\n    private rejectedUrls;\r\n    constructor(httpClient: HttpClient, authenticationService: IAuthenticationService, promiseUtils: PromiseUtils, httpUtils: HttpUtils, WHO_AM_I_RESOURCE_URI: string, eventService: IEventService);\r\n    predicate(request: HttpRequest<T>, response: HttpErrorResponse): boolean;\r\n    responseError(request: HttpRequest<T>, response: HttpErrorResponse): Promise<any>;\r\n    private isUrlNotRejected;\r\n}\r\n"}}
