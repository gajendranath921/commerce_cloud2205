/**
 * @fileoverview added by tsickle
 * Generated from: lib/notification/notification-service/notification.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { NotificationComponent } from '../notification/notification.component';
import { NotificationContainer } from '../notification-utils/notification-container';
import { NotificationConfig } from '../notification-utils/notification-config';
import { NotificationRef } from '../notification-utils/notification-ref';
import { DynamicComponentService } from '../../utils/dynamic-component/dynamic-component.service';
import { NotificationGroupComponent } from '../notification-group/notification-group.component';
export class NotificationService {
    /**
     * @param {?} dynamicComponentService
     */
    constructor(dynamicComponentService) {
        this.dynamicComponentService = dynamicComponentService;
        this.notifications = [];
    }
    /**
     * Opens an alert component with a content of type TemplateRef, Component Type or Configuration Object
     * @param {?} content Content of the alert component, or NotificationDefault object.
     * @param {?=} notificationConfig Configuration of the notification component.
     * @param {?=} notificationGroup Configuration of the notification component.
     * @return {?}
     */
    open(content, notificationConfig = new NotificationConfig(), notificationGroup) {
        // Reassigning Object And Service
        /** @type {?} */
        const notificationService = new NotificationRef();
        notificationConfig = Object.assign(new NotificationConfig(), notificationConfig);
        notificationService.data = notificationConfig.data;
        if (notificationService.data) {
            notificationService.data.type = notificationConfig.type;
        }
        // Create Container if it doesn't exist
        if (!this.containerRef) {
            this.containerRef = this.dynamicComponentService.createDynamicComponent(content, NotificationContainer, notificationConfig);
        }
        // Pass Container reference to config
        notificationConfig.container = this.containerRef.location.nativeElement;
        /** @type {?} */
        let notificationComponentRef;
        if (notificationGroup) {
            // If there is group Pass group reference as a container
            notificationConfig.container = notificationGroup.location.nativeElement;
            // Create Notification Component
            notificationComponentRef = this.dynamicComponentService.createDynamicComponent(content, NotificationComponent, notificationConfig, [notificationService]);
            // Add To array
            this.notifications.push({
                notificationComponent: notificationComponentRef,
                notificationGroup: notificationGroup
            });
        }
        else {
            // Create Notification Component
            notificationComponentRef = this.dynamicComponentService.createDynamicComponent(content, NotificationComponent, notificationConfig, [notificationService]);
            // Add To array
            this.notifications.push({
                notificationComponent: notificationComponentRef,
            });
        }
        /** @type {?} */
        const defaultBehaviourOnClose = (/**
         * @return {?}
         */
        () => {
            this.destroyNotificationComponent(notificationComponentRef);
            refSub.unsubscribe();
            refGroupSub.unsubscribe();
        });
        /** @type {?} */
        const defaultBehaviourOnGroupClose = (/**
         * @return {?}
         */
        () => {
            this.destroyWholeGroup(notificationComponentRef);
            refGroupSub.unsubscribe();
            refSub.unsubscribe();
        });
        /** @type {?} */
        const refSub = notificationService.afterClosed
            .subscribe(defaultBehaviourOnClose, defaultBehaviourOnClose);
        /** @type {?} */
        const refGroupSub = notificationService.afterClosedGroup
            .subscribe(defaultBehaviourOnGroupClose, defaultBehaviourOnGroupClose);
        return notificationService;
    }
    /**
     * Method to remove all of notifications from this service instance
     * @return {?}
     */
    destroyAll() {
        this.notifications.forEach((/**
         * @param {?} notification
         * @return {?}
         */
        notification => {
            this.destroyNotificationComponent(notification.notificationComponent);
        }));
    }
    /**
     * Method that informs if there is any notification opened in this service instance
     * @return {?}
     */
    isAnyOpened() {
        return this.notifications && this.notifications.length > 0;
    }
    /**
     * Method to create Notification Group
     * @param {?=} notificationConfig
     * @return {?}
     */
    createNotificationGroup(notificationConfig = new NotificationConfig()) {
        // Reassign Config Object
        notificationConfig = Object.assign(new NotificationConfig(), notificationConfig);
        if (!this.containerRef) {
            // Create Container Component
            this.containerRef = this.dynamicComponentService.createDynamicComponent(null, NotificationContainer, notificationConfig);
        }
        // Pass Container reference as a config container
        notificationConfig.container = this.containerRef.location.nativeElement;
        // Create and return notification Group component reference
        return this.dynamicComponentService.createDynamicComponent(null, NotificationGroupComponent, notificationConfig);
    }
    /**
     * @private
     * @param {?} notification
     * @return {?}
     */
    destroyWholeGroup(notification) {
        // Find Notification Group assigned to this Notification Component
        /** @type {?} */
        const arrayRef = this.notifications.find((/**
         * @param {?} item
         * @return {?}
         */
        item => item.notificationComponent === notification));
        if (arrayRef.notificationGroup) {
            // Find Any other Components, that are in this group
            /** @type {?} */
            const arrayToDelete = this.notifications
                .filter((/**
             * @param {?} _notification
             * @return {?}
             */
            _notification => _notification.notificationGroup === arrayRef.notificationGroup));
            // Destroy every single component, that are in the group
            arrayToDelete.forEach((/**
             * @param {?} _notification
             * @return {?}
             */
            _notification => this.destroyNotificationComponent(_notification.notificationComponent)));
        }
    }
    /**
     * @private
     * @param {?} notification
     * @return {?}
     */
    destroyNotificationComponent(notification) {
        // Find Notification component in the array.
        /** @type {?} */
        const arrayRef = this.notifications.find((/**
         * @param {?} item
         * @return {?}
         */
        item => item.notificationComponent === notification));
        /** @type {?} */
        const indexOf = this.notifications.indexOf(arrayRef);
        // Check the amount of component within the group
        /** @type {?} */
        const amountOfComponentsWithThisGroup = this.notifications.filter((/**
         * @param {?} item
         * @return {?}
         */
        item => item.notificationGroup && item.notificationGroup === arrayRef.notificationGroup));
        // If it's the only one component that is in the group, remove group component.
        if (amountOfComponentsWithThisGroup.length === 1) {
            this.dynamicComponentService.destroyComponent(arrayRef.notificationGroup);
        }
        // Destroy Component
        this.dynamicComponentService.destroyComponent(arrayRef.notificationComponent);
        // Remove it from Array
        this.notifications[indexOf] = null;
        this.notifications = this.notifications.filter((/**
         * @param {?} item
         * @return {?}
         */
        item => item !== null && item !== undefined));
        // If there is no other notification Components, just remove container.
        if (this.notifications.length === 0) {
            this.dynamicComponentService.destroyComponent(this.containerRef);
            this.containerRef = null;
        }
    }
}
NotificationService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
NotificationService.ctorParameters = () => [
    { type: DynamicComponentService }
];
if (false) {
    /** @type {?} */
    NotificationService.prototype.notifications;
    /** @type {?} */
    NotificationService.prototype.containerRef;
    /**
     * @type {?}
     * @private
     */
    NotificationService.prototype.dynamicComponentService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm90aWZpY2F0aW9uLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZnVuZGFtZW50YWwtbmd4L2NvcmUvIiwic291cmNlcyI6WyJsaWIvbm90aWZpY2F0aW9uL25vdGlmaWNhdGlvbi1zZXJ2aWNlL25vdGlmaWNhdGlvbi5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFnQixVQUFVLEVBQXFCLE1BQU0sZUFBZSxDQUFDO0FBQzVFLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLHdDQUF3QyxDQUFDO0FBQy9FLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLDhDQUE4QyxDQUFDO0FBQ3JGLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLDJDQUEyQyxDQUFDO0FBQy9FLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSx3Q0FBd0MsQ0FBQztBQUN6RSxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSx5REFBeUQsQ0FBQztBQUNsRyxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSxvREFBb0QsQ0FBQztBQUloRyxNQUFNLE9BQU8sbUJBQW1COzs7O0lBUzVCLFlBQ1ksdUJBQWdEO1FBQWhELDRCQUF1QixHQUF2Qix1QkFBdUIsQ0FBeUI7UUFSckQsa0JBQWEsR0FHZCxFQUFFLENBQUM7SUFNTixDQUFDOzs7Ozs7OztJQVFHLElBQUksQ0FDUCxPQUEyRCxFQUMzRCxxQkFBeUMsSUFBSSxrQkFBa0IsRUFBRSxFQUNqRSxpQkFBNEQ7OztjQUl0RCxtQkFBbUIsR0FBb0IsSUFBSSxlQUFlLEVBQUU7UUFDbEUsa0JBQWtCLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLGtCQUFrQixFQUFFLEVBQUUsa0JBQWtCLENBQUMsQ0FBQztRQUNqRixtQkFBbUIsQ0FBQyxJQUFJLEdBQUcsa0JBQWtCLENBQUMsSUFBSSxDQUFDO1FBQ25ELElBQUksbUJBQW1CLENBQUMsSUFBSSxFQUFFO1lBQzFCLG1CQUFtQixDQUFDLElBQUksQ0FBQyxJQUFJLEdBQUcsa0JBQWtCLENBQUMsSUFBSSxDQUFDO1NBQzNEO1FBRUQsdUNBQXVDO1FBQ3ZDLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFO1lBQ3BCLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLHVCQUF1QixDQUFDLHNCQUFzQixDQUFDLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxrQkFBa0IsQ0FBQyxDQUFDO1NBQy9IO1FBRUQscUNBQXFDO1FBQ3JDLGtCQUFrQixDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUM7O1lBQ3BFLHdCQUE2RDtRQUNqRSxJQUFJLGlCQUFpQixFQUFFO1lBRW5CLHdEQUF3RDtZQUN4RCxrQkFBa0IsQ0FBQyxTQUFTLEdBQUcsaUJBQWlCLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQztZQUV4RSxnQ0FBZ0M7WUFDaEMsd0JBQXdCLEdBQUcsSUFBSSxDQUFDLHVCQUF1QixDQUFDLHNCQUFzQixDQUMxRSxPQUFPLEVBQ1AscUJBQXFCLEVBQ3JCLGtCQUFrQixFQUNsQixDQUFDLG1CQUFtQixDQUFDLENBQ3hCLENBQUM7WUFFRixlQUFlO1lBQ2YsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUM7Z0JBQ3BCLHFCQUFxQixFQUFFLHdCQUF3QjtnQkFDL0MsaUJBQWlCLEVBQUUsaUJBQWlCO2FBQ3ZDLENBQUMsQ0FBQztTQUNOO2FBQU07WUFFSCxnQ0FBZ0M7WUFDaEMsd0JBQXdCLEdBQUcsSUFBSSxDQUFDLHVCQUF1QixDQUFDLHNCQUFzQixDQUMxRSxPQUFPLEVBQ1AscUJBQXFCLEVBQ3JCLGtCQUFrQixFQUNsQixDQUFDLG1CQUFtQixDQUFDLENBQ3hCLENBQUM7WUFFRixlQUFlO1lBQ2YsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUM7Z0JBQ3BCLHFCQUFxQixFQUFFLHdCQUF3QjthQUNsRCxDQUFDLENBQUM7U0FDTjs7Y0FFSyx1QkFBdUI7OztRQUFHLEdBQUcsRUFBRTtZQUNqQyxJQUFJLENBQUMsNEJBQTRCLENBQUMsd0JBQXdCLENBQUMsQ0FBQztZQUM1RCxNQUFNLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDckIsV0FBVyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQzlCLENBQUMsQ0FBQTs7Y0FFSyw0QkFBNEI7OztRQUFHLEdBQUcsRUFBRTtZQUN0QyxJQUFJLENBQUMsaUJBQWlCLENBQUMsd0JBQXdCLENBQUMsQ0FBQztZQUNqRCxXQUFXLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDMUIsTUFBTSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ3pCLENBQUMsQ0FBQTs7Y0FFSyxNQUFNLEdBQUcsbUJBQW1CLENBQUMsV0FBVzthQUN6QyxTQUFTLENBQUMsdUJBQXVCLEVBQUUsdUJBQXVCLENBQUM7O2NBRzFELFdBQVcsR0FBRyxtQkFBbUIsQ0FBQyxnQkFBZ0I7YUFDbkQsU0FBUyxDQUFDLDRCQUE0QixFQUFFLDRCQUE0QixDQUFDO1FBRzFFLE9BQU8sbUJBQW1CLENBQUM7SUFDL0IsQ0FBQzs7Ozs7SUFHTSxVQUFVO1FBQ2IsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPOzs7O1FBQUMsWUFBWSxDQUFDLEVBQUU7WUFDdEMsSUFBSSxDQUFDLDRCQUE0QixDQUFDLFlBQVksQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1FBQzFFLENBQUMsRUFBQyxDQUFBO0lBQ04sQ0FBQzs7Ozs7SUFHTSxXQUFXO1FBQ2QsT0FBTyxJQUFJLENBQUMsYUFBYSxJQUFJLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztJQUMvRCxDQUFDOzs7Ozs7SUFHTSx1QkFBdUIsQ0FDMUIscUJBQXlDLElBQUksa0JBQWtCLEVBQUU7UUFHakUseUJBQXlCO1FBQ3pCLGtCQUFrQixHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxrQkFBa0IsRUFBRSxFQUFFLGtCQUFrQixDQUFDLENBQUM7UUFFakYsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFFcEIsNkJBQTZCO1lBQzdCLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLHVCQUF1QixDQUFDLHNCQUFzQixDQUNuRSxJQUFJLEVBQUUscUJBQXFCLEVBQUUsa0JBQWtCLENBQ2xELENBQUM7U0FDTDtRQUVELGlEQUFpRDtRQUNqRCxrQkFBa0IsQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDO1FBRXhFLDJEQUEyRDtRQUMzRCxPQUFPLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxzQkFBc0IsQ0FDekIsSUFBSSxFQUFFLDBCQUEwQixFQUFFLGtCQUFrQixDQUFDLENBQ3JGO0lBQ0wsQ0FBQzs7Ozs7O0lBRU8saUJBQWlCLENBQUMsWUFBaUQ7OztjQUdqRSxRQUFRLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJOzs7O1FBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMscUJBQXFCLEtBQUssWUFBWSxFQUFDO1FBQzdGLElBQUksUUFBUSxDQUFDLGlCQUFpQixFQUFFOzs7a0JBR3RCLGFBQWEsR0FBRyxJQUFJLENBQUMsYUFBYTtpQkFDbkMsTUFBTTs7OztZQUFDLGFBQWEsQ0FBQyxFQUFFLENBQUMsYUFBYSxDQUFDLGlCQUFpQixLQUFLLFFBQVEsQ0FBQyxpQkFBaUIsRUFBQztZQUc1Rix3REFBd0Q7WUFDeEQsYUFBYSxDQUFDLE9BQU87Ozs7WUFBQyxhQUFhLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyw0QkFBNEIsQ0FBQyxhQUFhLENBQUMscUJBQXFCLENBQUMsRUFBQyxDQUFDO1NBQ2xIO0lBRUwsQ0FBQzs7Ozs7O0lBRU8sNEJBQTRCLENBQUMsWUFBaUQ7OztjQUc1RSxRQUFRLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJOzs7O1FBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMscUJBQXFCLEtBQUssWUFBWSxFQUFDOztjQUN2RixPQUFPLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDOzs7Y0FHOUMsK0JBQStCLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNOzs7O1FBQUMsSUFBSSxDQUFDLEVBQUUsQ0FDckUsSUFBSSxDQUFDLGlCQUFpQixJQUFJLElBQUksQ0FBQyxpQkFBaUIsS0FBSyxRQUFRLENBQUMsaUJBQWlCLEVBQ2xGO1FBRUQsK0VBQStFO1FBQy9FLElBQUksK0JBQStCLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtZQUM5QyxJQUFJLENBQUMsdUJBQXVCLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLGlCQUFpQixDQUFDLENBQUM7U0FDN0U7UUFFRCxvQkFBb0I7UUFDcEIsSUFBSSxDQUFDLHVCQUF1QixDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1FBRTlFLHVCQUF1QjtRQUN2QixJQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxHQUFHLElBQUksQ0FBQztRQUNuQyxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTTs7OztRQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxLQUFLLElBQUksSUFBSSxJQUFJLEtBQUssU0FBUyxFQUFDLENBQUM7UUFFNUYsdUVBQXVFO1FBQ3ZFLElBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1lBQ2pDLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7WUFDakUsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7U0FDNUI7SUFFTCxDQUFDOzs7WUF0TEosVUFBVTs7OztZQUpGLHVCQUF1Qjs7OztJQU81Qiw0Q0FHUzs7SUFDVCwyQ0FBeUQ7Ozs7O0lBSXJELHNEQUF3RCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudFJlZiwgSW5qZWN0YWJsZSwgVGVtcGxhdGVSZWYsIFR5cGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE5vdGlmaWNhdGlvbkNvbXBvbmVudCB9IGZyb20gJy4uL25vdGlmaWNhdGlvbi9ub3RpZmljYXRpb24uY29tcG9uZW50JztcbmltcG9ydCB7IE5vdGlmaWNhdGlvbkNvbnRhaW5lciB9IGZyb20gJy4uL25vdGlmaWNhdGlvbi11dGlscy9ub3RpZmljYXRpb24tY29udGFpbmVyJztcbmltcG9ydCB7IE5vdGlmaWNhdGlvbkNvbmZpZyB9IGZyb20gJy4uL25vdGlmaWNhdGlvbi11dGlscy9ub3RpZmljYXRpb24tY29uZmlnJztcbmltcG9ydCB7IE5vdGlmaWNhdGlvblJlZiB9IGZyb20gJy4uL25vdGlmaWNhdGlvbi11dGlscy9ub3RpZmljYXRpb24tcmVmJztcbmltcG9ydCB7IER5bmFtaWNDb21wb25lbnRTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vdXRpbHMvZHluYW1pYy1jb21wb25lbnQvZHluYW1pYy1jb21wb25lbnQuc2VydmljZSc7XG5pbXBvcnQgeyBOb3RpZmljYXRpb25Hcm91cENvbXBvbmVudCB9IGZyb20gJy4uL25vdGlmaWNhdGlvbi1ncm91cC9ub3RpZmljYXRpb24tZ3JvdXAuY29tcG9uZW50JztcbmltcG9ydCB7IE5vdGlmaWNhdGlvbkRlZmF1bHQgfSBmcm9tICcuLi9ub3RpZmljYXRpb24tdXRpbHMvbm90aWZpY2F0aW9uLWRlZmF1bHQnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgTm90aWZpY2F0aW9uU2VydmljZSB7XG5cbiAgICBwdWJsaWMgbm90aWZpY2F0aW9uczoge1xuICAgICAgICBub3RpZmljYXRpb25Db21wb25lbnQ6IENvbXBvbmVudFJlZjxOb3RpZmljYXRpb25Db21wb25lbnQ+LFxuICAgICAgICBub3RpZmljYXRpb25Hcm91cD86IENvbXBvbmVudFJlZjxOb3RpZmljYXRpb25Hcm91cENvbXBvbmVudD5cbiAgICB9W10gPSBbXTtcbiAgICBwdWJsaWMgY29udGFpbmVyUmVmOiBDb21wb25lbnRSZWY8Tm90aWZpY2F0aW9uQ29udGFpbmVyPjtcblxuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHByaXZhdGUgZHluYW1pY0NvbXBvbmVudFNlcnZpY2U6IER5bmFtaWNDb21wb25lbnRTZXJ2aWNlXG4gICAgKSB7fVxuXG4gICAgLyoqXG4gICAgICogT3BlbnMgYW4gYWxlcnQgY29tcG9uZW50IHdpdGggYSBjb250ZW50IG9mIHR5cGUgVGVtcGxhdGVSZWYsIENvbXBvbmVudCBUeXBlIG9yIENvbmZpZ3VyYXRpb24gT2JqZWN0XG4gICAgICogQHBhcmFtIGNvbnRlbnQgQ29udGVudCBvZiB0aGUgYWxlcnQgY29tcG9uZW50LCBvciBOb3RpZmljYXRpb25EZWZhdWx0IG9iamVjdC5cbiAgICAgKiBAcGFyYW0gbm90aWZpY2F0aW9uQ29uZmlnIENvbmZpZ3VyYXRpb24gb2YgdGhlIG5vdGlmaWNhdGlvbiBjb21wb25lbnQuXG4gICAgICogQHBhcmFtIG5vdGlmaWNhdGlvbkdyb3VwIENvbmZpZ3VyYXRpb24gb2YgdGhlIG5vdGlmaWNhdGlvbiBjb21wb25lbnQuXG4gICAgICovXG4gICAgcHVibGljIG9wZW4oXG4gICAgICAgIGNvbnRlbnQ6IFRlbXBsYXRlUmVmPGFueT4gfCBUeXBlPGFueT4gfCBOb3RpZmljYXRpb25EZWZhdWx0LFxuICAgICAgICBub3RpZmljYXRpb25Db25maWc6IE5vdGlmaWNhdGlvbkNvbmZpZyA9IG5ldyBOb3RpZmljYXRpb25Db25maWcoKSxcbiAgICAgICAgbm90aWZpY2F0aW9uR3JvdXA/OiBDb21wb25lbnRSZWY8Tm90aWZpY2F0aW9uR3JvdXBDb21wb25lbnQ+XG4gICAgKTogTm90aWZpY2F0aW9uUmVmIHtcblxuICAgICAgICAvLyBSZWFzc2lnbmluZyBPYmplY3QgQW5kIFNlcnZpY2VcbiAgICAgICAgY29uc3Qgbm90aWZpY2F0aW9uU2VydmljZTogTm90aWZpY2F0aW9uUmVmID0gbmV3IE5vdGlmaWNhdGlvblJlZigpO1xuICAgICAgICBub3RpZmljYXRpb25Db25maWcgPSBPYmplY3QuYXNzaWduKG5ldyBOb3RpZmljYXRpb25Db25maWcoKSwgbm90aWZpY2F0aW9uQ29uZmlnKTtcbiAgICAgICAgbm90aWZpY2F0aW9uU2VydmljZS5kYXRhID0gbm90aWZpY2F0aW9uQ29uZmlnLmRhdGE7XG4gICAgICAgIGlmIChub3RpZmljYXRpb25TZXJ2aWNlLmRhdGEpIHtcbiAgICAgICAgICAgIG5vdGlmaWNhdGlvblNlcnZpY2UuZGF0YS50eXBlID0gbm90aWZpY2F0aW9uQ29uZmlnLnR5cGU7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBDcmVhdGUgQ29udGFpbmVyIGlmIGl0IGRvZXNuJ3QgZXhpc3RcbiAgICAgICAgaWYgKCF0aGlzLmNvbnRhaW5lclJlZikge1xuICAgICAgICAgICAgdGhpcy5jb250YWluZXJSZWYgPSB0aGlzLmR5bmFtaWNDb21wb25lbnRTZXJ2aWNlLmNyZWF0ZUR5bmFtaWNDb21wb25lbnQoY29udGVudCwgTm90aWZpY2F0aW9uQ29udGFpbmVyLCBub3RpZmljYXRpb25Db25maWcpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gUGFzcyBDb250YWluZXIgcmVmZXJlbmNlIHRvIGNvbmZpZ1xuICAgICAgICBub3RpZmljYXRpb25Db25maWcuY29udGFpbmVyID0gdGhpcy5jb250YWluZXJSZWYubG9jYXRpb24ubmF0aXZlRWxlbWVudDtcbiAgICAgICAgbGV0IG5vdGlmaWNhdGlvbkNvbXBvbmVudFJlZjogQ29tcG9uZW50UmVmPE5vdGlmaWNhdGlvbkNvbXBvbmVudD47XG4gICAgICAgIGlmIChub3RpZmljYXRpb25Hcm91cCkge1xuXG4gICAgICAgICAgICAvLyBJZiB0aGVyZSBpcyBncm91cCBQYXNzIGdyb3VwIHJlZmVyZW5jZSBhcyBhIGNvbnRhaW5lclxuICAgICAgICAgICAgbm90aWZpY2F0aW9uQ29uZmlnLmNvbnRhaW5lciA9IG5vdGlmaWNhdGlvbkdyb3VwLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQ7XG5cbiAgICAgICAgICAgIC8vIENyZWF0ZSBOb3RpZmljYXRpb24gQ29tcG9uZW50XG4gICAgICAgICAgICBub3RpZmljYXRpb25Db21wb25lbnRSZWYgPSB0aGlzLmR5bmFtaWNDb21wb25lbnRTZXJ2aWNlLmNyZWF0ZUR5bmFtaWNDb21wb25lbnQoXG4gICAgICAgICAgICAgICAgY29udGVudCxcbiAgICAgICAgICAgICAgICBOb3RpZmljYXRpb25Db21wb25lbnQsXG4gICAgICAgICAgICAgICAgbm90aWZpY2F0aW9uQ29uZmlnLFxuICAgICAgICAgICAgICAgIFtub3RpZmljYXRpb25TZXJ2aWNlXVxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgLy8gQWRkIFRvIGFycmF5XG4gICAgICAgICAgICB0aGlzLm5vdGlmaWNhdGlvbnMucHVzaCh7XG4gICAgICAgICAgICAgICAgbm90aWZpY2F0aW9uQ29tcG9uZW50OiBub3RpZmljYXRpb25Db21wb25lbnRSZWYsXG4gICAgICAgICAgICAgICAgbm90aWZpY2F0aW9uR3JvdXA6IG5vdGlmaWNhdGlvbkdyb3VwXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgLy8gQ3JlYXRlIE5vdGlmaWNhdGlvbiBDb21wb25lbnRcbiAgICAgICAgICAgIG5vdGlmaWNhdGlvbkNvbXBvbmVudFJlZiA9IHRoaXMuZHluYW1pY0NvbXBvbmVudFNlcnZpY2UuY3JlYXRlRHluYW1pY0NvbXBvbmVudChcbiAgICAgICAgICAgICAgICBjb250ZW50LFxuICAgICAgICAgICAgICAgIE5vdGlmaWNhdGlvbkNvbXBvbmVudCxcbiAgICAgICAgICAgICAgICBub3RpZmljYXRpb25Db25maWcsXG4gICAgICAgICAgICAgICAgW25vdGlmaWNhdGlvblNlcnZpY2VdXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAvLyBBZGQgVG8gYXJyYXlcbiAgICAgICAgICAgIHRoaXMubm90aWZpY2F0aW9ucy5wdXNoKHtcbiAgICAgICAgICAgICAgICBub3RpZmljYXRpb25Db21wb25lbnQ6IG5vdGlmaWNhdGlvbkNvbXBvbmVudFJlZixcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZGVmYXVsdEJlaGF2aW91ck9uQ2xvc2UgPSAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmRlc3Ryb3lOb3RpZmljYXRpb25Db21wb25lbnQobm90aWZpY2F0aW9uQ29tcG9uZW50UmVmKTtcbiAgICAgICAgICAgIHJlZlN1Yi51bnN1YnNjcmliZSgpO1xuICAgICAgICAgICAgcmVmR3JvdXBTdWIudW5zdWJzY3JpYmUoKTtcbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCBkZWZhdWx0QmVoYXZpb3VyT25Hcm91cENsb3NlID0gKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5kZXN0cm95V2hvbGVHcm91cChub3RpZmljYXRpb25Db21wb25lbnRSZWYpO1xuICAgICAgICAgICAgcmVmR3JvdXBTdWIudW5zdWJzY3JpYmUoKTtcbiAgICAgICAgICAgIHJlZlN1Yi51bnN1YnNjcmliZSgpO1xuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IHJlZlN1YiA9IG5vdGlmaWNhdGlvblNlcnZpY2UuYWZ0ZXJDbG9zZWRcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoZGVmYXVsdEJlaGF2aW91ck9uQ2xvc2UsIGRlZmF1bHRCZWhhdmlvdXJPbkNsb3NlKVxuICAgICAgICA7XG5cbiAgICAgICAgY29uc3QgcmVmR3JvdXBTdWIgPSBub3RpZmljYXRpb25TZXJ2aWNlLmFmdGVyQ2xvc2VkR3JvdXBcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoZGVmYXVsdEJlaGF2aW91ck9uR3JvdXBDbG9zZSwgZGVmYXVsdEJlaGF2aW91ck9uR3JvdXBDbG9zZSlcbiAgICAgICAgO1xuXG4gICAgICAgIHJldHVybiBub3RpZmljYXRpb25TZXJ2aWNlO1xuICAgIH1cblxuICAgIC8qKiBNZXRob2QgdG8gcmVtb3ZlIGFsbCBvZiBub3RpZmljYXRpb25zIGZyb20gdGhpcyBzZXJ2aWNlIGluc3RhbmNlICovXG4gICAgcHVibGljIGRlc3Ryb3lBbGwoKTogdm9pZCB7XG4gICAgICAgIHRoaXMubm90aWZpY2F0aW9ucy5mb3JFYWNoKG5vdGlmaWNhdGlvbiA9PiB7XG4gICAgICAgICAgICB0aGlzLmRlc3Ryb3lOb3RpZmljYXRpb25Db21wb25lbnQobm90aWZpY2F0aW9uLm5vdGlmaWNhdGlvbkNvbXBvbmVudCk7XG4gICAgICAgIH0pXG4gICAgfVxuXG4gICAgLyoqIE1ldGhvZCB0aGF0IGluZm9ybXMgaWYgdGhlcmUgaXMgYW55IG5vdGlmaWNhdGlvbiBvcGVuZWQgaW4gdGhpcyBzZXJ2aWNlIGluc3RhbmNlICovXG4gICAgcHVibGljIGlzQW55T3BlbmVkKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5ub3RpZmljYXRpb25zICYmIHRoaXMubm90aWZpY2F0aW9ucy5sZW5ndGggPiAwO1xuICAgIH1cblxuICAgIC8qKiBNZXRob2QgdG8gY3JlYXRlIE5vdGlmaWNhdGlvbiBHcm91cCAqL1xuICAgIHB1YmxpYyBjcmVhdGVOb3RpZmljYXRpb25Hcm91cCAoXG4gICAgICAgIG5vdGlmaWNhdGlvbkNvbmZpZzogTm90aWZpY2F0aW9uQ29uZmlnID0gbmV3IE5vdGlmaWNhdGlvbkNvbmZpZygpLFxuICAgICk6IENvbXBvbmVudFJlZjxOb3RpZmljYXRpb25Hcm91cENvbXBvbmVudD4ge1xuXG4gICAgICAgIC8vIFJlYXNzaWduIENvbmZpZyBPYmplY3RcbiAgICAgICAgbm90aWZpY2F0aW9uQ29uZmlnID0gT2JqZWN0LmFzc2lnbihuZXcgTm90aWZpY2F0aW9uQ29uZmlnKCksIG5vdGlmaWNhdGlvbkNvbmZpZyk7XG5cbiAgICAgICAgaWYgKCF0aGlzLmNvbnRhaW5lclJlZikge1xuXG4gICAgICAgICAgICAvLyBDcmVhdGUgQ29udGFpbmVyIENvbXBvbmVudFxuICAgICAgICAgICAgdGhpcy5jb250YWluZXJSZWYgPSB0aGlzLmR5bmFtaWNDb21wb25lbnRTZXJ2aWNlLmNyZWF0ZUR5bmFtaWNDb21wb25lbnQoXG4gICAgICAgICAgICAgICAgbnVsbCwgTm90aWZpY2F0aW9uQ29udGFpbmVyLCBub3RpZmljYXRpb25Db25maWdcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBQYXNzIENvbnRhaW5lciByZWZlcmVuY2UgYXMgYSBjb25maWcgY29udGFpbmVyXG4gICAgICAgIG5vdGlmaWNhdGlvbkNvbmZpZy5jb250YWluZXIgPSB0aGlzLmNvbnRhaW5lclJlZi5sb2NhdGlvbi5uYXRpdmVFbGVtZW50O1xuXG4gICAgICAgIC8vIENyZWF0ZSBhbmQgcmV0dXJuIG5vdGlmaWNhdGlvbiBHcm91cCBjb21wb25lbnQgcmVmZXJlbmNlXG4gICAgICAgIHJldHVybiB0aGlzLmR5bmFtaWNDb21wb25lbnRTZXJ2aWNlLmNyZWF0ZUR5bmFtaWNDb21wb25lbnRcbiAgICAgICAgICAgIDxOb3RpZmljYXRpb25Hcm91cENvbXBvbmVudD4obnVsbCwgTm90aWZpY2F0aW9uR3JvdXBDb21wb25lbnQsIG5vdGlmaWNhdGlvbkNvbmZpZylcbiAgICAgICAgO1xuICAgIH1cblxuICAgIHByaXZhdGUgZGVzdHJveVdob2xlR3JvdXAobm90aWZpY2F0aW9uOiBDb21wb25lbnRSZWY8Tm90aWZpY2F0aW9uQ29tcG9uZW50Pik6IHZvaWQge1xuXG4gICAgICAgIC8vIEZpbmQgTm90aWZpY2F0aW9uIEdyb3VwIGFzc2lnbmVkIHRvIHRoaXMgTm90aWZpY2F0aW9uIENvbXBvbmVudFxuICAgICAgICBjb25zdCBhcnJheVJlZiA9IHRoaXMubm90aWZpY2F0aW9ucy5maW5kKGl0ZW0gPT4gaXRlbS5ub3RpZmljYXRpb25Db21wb25lbnQgPT09IG5vdGlmaWNhdGlvbik7XG4gICAgICAgIGlmIChhcnJheVJlZi5ub3RpZmljYXRpb25Hcm91cCkge1xuXG4gICAgICAgICAgICAvLyBGaW5kIEFueSBvdGhlciBDb21wb25lbnRzLCB0aGF0IGFyZSBpbiB0aGlzIGdyb3VwXG4gICAgICAgICAgICBjb25zdCBhcnJheVRvRGVsZXRlID0gdGhpcy5ub3RpZmljYXRpb25zXG4gICAgICAgICAgICAgICAgLmZpbHRlcihfbm90aWZpY2F0aW9uID0+IF9ub3RpZmljYXRpb24ubm90aWZpY2F0aW9uR3JvdXAgPT09IGFycmF5UmVmLm5vdGlmaWNhdGlvbkdyb3VwKVxuICAgICAgICAgICAgO1xuXG4gICAgICAgICAgICAvLyBEZXN0cm95IGV2ZXJ5IHNpbmdsZSBjb21wb25lbnQsIHRoYXQgYXJlIGluIHRoZSBncm91cFxuICAgICAgICAgICAgYXJyYXlUb0RlbGV0ZS5mb3JFYWNoKF9ub3RpZmljYXRpb24gPT4gdGhpcy5kZXN0cm95Tm90aWZpY2F0aW9uQ29tcG9uZW50KF9ub3RpZmljYXRpb24ubm90aWZpY2F0aW9uQ29tcG9uZW50KSk7XG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIHByaXZhdGUgZGVzdHJveU5vdGlmaWNhdGlvbkNvbXBvbmVudChub3RpZmljYXRpb246IENvbXBvbmVudFJlZjxOb3RpZmljYXRpb25Db21wb25lbnQ+KTogdm9pZCB7XG5cbiAgICAgICAgLy8gRmluZCBOb3RpZmljYXRpb24gY29tcG9uZW50IGluIHRoZSBhcnJheS5cbiAgICAgICAgY29uc3QgYXJyYXlSZWYgPSB0aGlzLm5vdGlmaWNhdGlvbnMuZmluZChpdGVtID0+IGl0ZW0ubm90aWZpY2F0aW9uQ29tcG9uZW50ID09PSBub3RpZmljYXRpb24pO1xuICAgICAgICBjb25zdCBpbmRleE9mID0gdGhpcy5ub3RpZmljYXRpb25zLmluZGV4T2YoYXJyYXlSZWYpO1xuXG4gICAgICAgIC8vIENoZWNrIHRoZSBhbW91bnQgb2YgY29tcG9uZW50IHdpdGhpbiB0aGUgZ3JvdXBcbiAgICAgICAgY29uc3QgYW1vdW50T2ZDb21wb25lbnRzV2l0aFRoaXNHcm91cCA9IHRoaXMubm90aWZpY2F0aW9ucy5maWx0ZXIoaXRlbSA9PlxuICAgICAgICAgICAgaXRlbS5ub3RpZmljYXRpb25Hcm91cCAmJiBpdGVtLm5vdGlmaWNhdGlvbkdyb3VwID09PSBhcnJheVJlZi5ub3RpZmljYXRpb25Hcm91cFxuICAgICAgICApO1xuXG4gICAgICAgIC8vIElmIGl0J3MgdGhlIG9ubHkgb25lIGNvbXBvbmVudCB0aGF0IGlzIGluIHRoZSBncm91cCwgcmVtb3ZlIGdyb3VwIGNvbXBvbmVudC5cbiAgICAgICAgaWYgKGFtb3VudE9mQ29tcG9uZW50c1dpdGhUaGlzR3JvdXAubGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgICB0aGlzLmR5bmFtaWNDb21wb25lbnRTZXJ2aWNlLmRlc3Ryb3lDb21wb25lbnQoYXJyYXlSZWYubm90aWZpY2F0aW9uR3JvdXApO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gRGVzdHJveSBDb21wb25lbnRcbiAgICAgICAgdGhpcy5keW5hbWljQ29tcG9uZW50U2VydmljZS5kZXN0cm95Q29tcG9uZW50KGFycmF5UmVmLm5vdGlmaWNhdGlvbkNvbXBvbmVudCk7XG5cbiAgICAgICAgLy8gUmVtb3ZlIGl0IGZyb20gQXJyYXlcbiAgICAgICAgdGhpcy5ub3RpZmljYXRpb25zW2luZGV4T2ZdID0gbnVsbDtcbiAgICAgICAgdGhpcy5ub3RpZmljYXRpb25zID0gdGhpcy5ub3RpZmljYXRpb25zLmZpbHRlcihpdGVtID0+IGl0ZW0gIT09IG51bGwgJiYgaXRlbSAhPT0gdW5kZWZpbmVkKTtcblxuICAgICAgICAvLyBJZiB0aGVyZSBpcyBubyBvdGhlciBub3RpZmljYXRpb24gQ29tcG9uZW50cywganVzdCByZW1vdmUgY29udGFpbmVyLlxuICAgICAgICBpZiAodGhpcy5ub3RpZmljYXRpb25zLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgdGhpcy5keW5hbWljQ29tcG9uZW50U2VydmljZS5kZXN0cm95Q29tcG9uZW50KHRoaXMuY29udGFpbmVyUmVmKTtcbiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyUmVmID0gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgfVxufVxuIl19