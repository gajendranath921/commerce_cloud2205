{"version":3,"file":"RushVersionSelector.js","sourceRoot":"","sources":["../src/RushVersionSelector.ts"],"names":[],"mappings":";AAAA,4FAA4F;AAC5F,2DAA2D;;;;;;;;;;;;;;;;;;;;;;AAE3D,2CAA6B;AAC7B,+CAAiC;AAEjC,oEAAwD;AACxD,2EAAwE;AACxE,kDAA0F;AAE1F,+DAA4D;AAG5D,MAAM,oBAAoB,GAAW,CAAC,CAAC;AAEvC,MAAa,mBAAmB;IAI9B,YAAmB,qBAA6B;QAC9C,IAAI,CAAC,iBAAiB,GAAG,IAAI,4BAAiB,EAAE,CAAC;QACjD,IAAI,CAAC,sBAAsB,GAAG,qBAAqB,CAAC;IACtD,CAAC;IAEM,KAAK,CAAC,+BAA+B,CAC1C,OAAe,EACf,aAAmD,EACnD,cAA8B;QAE9B,MAAM,mBAAmB,GAAY,MAAM,CAAC,EAAE,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;QACjE,MAAM,gBAAgB,GAAW,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,iBAAiB,CAAC,gBAAgB,EAAE,QAAQ,OAAO,EAAE,CAAC,CAAC;QAEvG,MAAM,aAAa,GAAqB,IAAI,2BAAgB,CAAC,gBAAgB,EAAE;YAC7E,IAAI,EAAE,OAAO,CAAC,QAAQ,CAAC,IAAI;SAC5B,CAAC,CAAC;QAEH,IAAI,CAAC,aAAa,CAAC,OAAO,EAAE,EAAE;YAC5B,uBAAuB;YACvB,OAAO,CAAC,GAAG,CAAC,gBAAgB,OAAO,4CAA4C,CAAC,CAAC;YAEjF,MAAM,YAAY,GAAW,QAAQ,OAAO,EAAE,CAAC;YAE/C,OAAO,CAAC,GAAG,CAAC,8BAA8B,YAAY,EAAE,CAAC,CAAC;YAE1D,MAAM,IAAI,GAAa,MAAM,4BAAQ,CAAC,OAAO,CAAC,gBAAgB,EAAE,YAAY,CAAC,CAAC;YAC9E,IAAI,aAAa,CAAC,OAAO,EAAE,EAAE;gBAC3B,OAAO,CAAC,GAAG,CAAC,6CAA6C,CAAC,CAAC;aAC5D;iBAAM;gBACL,qBAAS,CAAC,yBAAyB,CAAC;oBAClC,SAAS,EAAE,gBAAgB;oBAC3B,WAAW,EAAE,mBAAmB,CAAC,CAAC,CAAC,iBAAiB,CAAC,CAAC,CAAC,qBAAqB;oBAC5E,OAAO,EAAE,OAAO;oBAChB,gBAAgB,EAAE,oBAAoB;oBACtC,kBAAkB,EAAE,oBAAoB;oBACxC,wFAAwF;oBACxF,mFAAmF;oBACnF,mFAAmF;oBACnF,gFAAgF;oBAChF,qEAAqE;oBACrE,yEAAyE;oBACzE,sBAAsB,EAAE,aAAa,CAAC,CAAC,CAAC,aAAa,CAAC,sBAAsB,CAAC,CAAC,CAAC,SAAS;oBACxF,cAAc,EAAE,IAAI;iBACrB,CAAC,CAAC;gBAEH,OAAO,CAAC,GAAG,CAAC,uCAAuC,OAAO,OAAO,gBAAgB,GAAG,CAAC,CAAC;gBAEtF,+DAA+D;gBAC/D,aAAa,CAAC,MAAM,EAAE,CAAC;gBAEvB,IAAI,CAAC,OAAO,EAAE,CAAC;aAChB;SACF;QAED,IAAI,MAAM,CAAC,EAAE,CAAC,OAAO,EAAE,QAAQ,CAAC,EAAE;YAChC,0FAA0F;YAC1F,8BAA8B;YAC9B,yCAAmB,CAAC,sBAAsB,CAAC,OAAO,CAAC,CAAC;YACpD,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,gBAAgB,EAAE,cAAc,EAAE,YAAY,EAAE,MAAM,EAAE,KAAK,EAAE,MAAM,CAAC,CAAC,CAAC;SAC3F;aAAM,IAAI,MAAM,CAAC,EAAE,CAAC,OAAO,EAAE,OAAO,CAAC,EAAE;YACtC,0FAA0F;YAC1F,8BAA8B;YAC9B,yCAAmB,CAAC,sBAAsB,CAAC,OAAO,CAAC,CAAC;YACpD,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,gBAAgB,EAAE,cAAc,EAAE,YAAY,EAAE,MAAM,EAAE,KAAK,EAAE,OAAO,CAAC,CAAC,CAAC;SAC5F;aAAM;YACL,uFAAuF;YACvF,MAAM,iBAAiB,GAAO,OAAO,CAAC,IAAI,CAAC,IAAI,CAC7C,gBAAgB,EAChB,cAAc,EACd,YAAY,EACZ,UAAU,EACV,KAAK,EACL,OAAO,CACR,CAAC,CAAC;YACH,yCAAmB,CAAC,OAAO,CAAC,IAAI,CAAC,sBAAsB,EAAE,iBAAiB,EAAE,cAAc,CAAC,CAAC;SAC7F;IACH,CAAC;CACF;AAjFD,kDAiFC","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\n// See LICENSE in the project root for license information.\n\nimport * as path from 'path';\nimport * as semver from 'semver';\n\nimport { LockFile } from '@rushstack/node-core-library';\nimport { Utilities } from '@microsoft/rush-lib/lib/utilities/Utilities';\nimport { _LastInstallFlag, _RushGlobalFolder, ILaunchOptions } from '@microsoft/rush-lib';\n\nimport { RushCommandSelector } from './RushCommandSelector';\nimport { MinimalRushConfiguration } from './MinimalRushConfiguration';\n\nconst MAX_INSTALL_ATTEMPTS: number = 3;\n\nexport class RushVersionSelector {\n  private _rushGlobalFolder: _RushGlobalFolder;\n  private _currentPackageVersion: string;\n\n  public constructor(currentPackageVersion: string) {\n    this._rushGlobalFolder = new _RushGlobalFolder();\n    this._currentPackageVersion = currentPackageVersion;\n  }\n\n  public async ensureRushVersionInstalledAsync(\n    version: string,\n    configuration: MinimalRushConfiguration | undefined,\n    executeOptions: ILaunchOptions\n  ): Promise<void> {\n    const isLegacyRushVersion: boolean = semver.lt(version, '4.0.0');\n    const expectedRushPath: string = path.join(this._rushGlobalFolder.nodeSpecificPath, `rush-${version}`);\n\n    const installMarker: _LastInstallFlag = new _LastInstallFlag(expectedRushPath, {\n      node: process.versions.node\n    });\n\n    if (!installMarker.isValid()) {\n      // Need to install Rush\n      console.log(`Rush version ${version} is not currently installed. Installing...`);\n\n      const resourceName: string = `rush-${version}`;\n\n      console.log(`Trying to acquire lock for ${resourceName}`);\n\n      const lock: LockFile = await LockFile.acquire(expectedRushPath, resourceName);\n      if (installMarker.isValid()) {\n        console.log('Another process performed the installation.');\n      } else {\n        Utilities.installPackageInDirectory({\n          directory: expectedRushPath,\n          packageName: isLegacyRushVersion ? '@microsoft/rush' : '@microsoft/rush-lib',\n          version: version,\n          tempPackageTitle: 'rush-local-install',\n          maxInstallAttempts: MAX_INSTALL_ATTEMPTS,\n          // This is using a local configuration to install a package in a shared global location.\n          // Generally that's a bad practice, but in this case if we can successfully install\n          // the package at all, we can reasonably assume it's good for all the repositories.\n          // In particular, we'll assume that two different NPM registries cannot have two\n          // different implementations of the same version of the same package.\n          // This was needed for: https://github.com/microsoft/rushstack/issues/691\n          commonRushConfigFolder: configuration ? configuration.commonRushConfigFolder : undefined,\n          suppressOutput: true\n        });\n\n        console.log(`Successfully installed Rush version ${version} in ${expectedRushPath}.`);\n\n        // If we've made it here without exception, write the flag file\n        installMarker.create();\n\n        lock.release();\n      }\n    }\n\n    if (semver.lt(version, '3.0.20')) {\n      // In old versions, requiring the entry point invoked the command-line parser immediately,\n      // so fail if \"rushx\" was used\n      RushCommandSelector.failIfNotInvokedAsRush(version);\n      require(path.join(expectedRushPath, 'node_modules', '@microsoft', 'rush', 'lib', 'rush'));\n    } else if (semver.lt(version, '4.0.0')) {\n      // In old versions, requiring the entry point invoked the command-line parser immediately,\n      // so fail if \"rushx\" was used\n      RushCommandSelector.failIfNotInvokedAsRush(version);\n      require(path.join(expectedRushPath, 'node_modules', '@microsoft', 'rush', 'lib', 'start'));\n    } else {\n      // For newer rush-lib, RushCommandSelector can test whether \"rushx\" is supported or not\n      const rushCliEntrypoint: {} = require(path.join(\n        expectedRushPath,\n        'node_modules',\n        '@microsoft',\n        'rush-lib',\n        'lib',\n        'index'\n      ));\n      RushCommandSelector.execute(this._currentPackageVersion, rushCliEntrypoint, executeOptions);\n    }\n  }\n}\n"]}