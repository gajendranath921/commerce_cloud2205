{"version":3,"file":"PhasedScriptAction.js","sourceRoot":"","sources":["../../../src/cli/scriptActions/PhasedScriptAction.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\n// See LICENSE in the project root for license information.\n\nimport * as os from 'os';\nimport colors from 'colors/safe';\n\nimport { AlreadyReportedError, Terminal } from '@rushstack/node-core-library';\nimport { CommandLineFlagParameter, CommandLineStringParameter } from '@rushstack/ts-command-line';\n\nimport { SetupChecks } from '../../logic/SetupChecks';\nimport { Stopwatch, StopwatchState } from '../../utilities/Stopwatch';\nimport { BaseScriptAction, IBaseScriptActionOptions } from './BaseScriptAction';\nimport {\n  IOperationExecutionManagerOptions,\n  OperationExecutionManager\n} from '../../logic/operations/OperationExecutionManager';\nimport { RushConstants } from '../../logic/RushConstants';\nimport { EnvironmentVariableNames } from '../../api/EnvironmentConfiguration';\nimport { LastLinkFlag, LastLinkFlagFactory } from '../../api/LastLinkFlag';\nimport { RushConfigurationProject } from '../../api/RushConfigurationProject';\nimport { BuildCacheConfiguration } from '../../api/BuildCacheConfiguration';\nimport { SelectionParameterSet } from '../SelectionParameterSet';\nimport type { CommandLineConfiguration, IPhase, IPhasedCommand } from '../../api/CommandLineConfiguration';\nimport { OperationSelector } from '../../logic/operations/OperationSelector';\nimport { Selection } from '../../logic/Selection';\nimport { IOperationFactoryOptions, OperationFactory } from '../../logic/operations/ShellOperationFactory';\nimport { Event } from '../../api/EventHooks';\nimport { ProjectChangeAnalyzer } from '../../logic/ProjectChangeAnalyzer';\n\n/**\n * Constructor parameters for BulkScriptAction.\n */\nexport interface IPhasedScriptActionOptions extends IBaseScriptActionOptions<IPhasedCommand> {\n  enableParallelism: boolean;\n  incremental: boolean;\n  disableBuildCache: boolean;\n\n  initialPhases: Set<IPhase>;\n  watchPhases: Set<IPhase>;\n  phases: Map<string, IPhase>;\n\n  alwaysWatch: boolean;\n}\n\ninterface IExecuteInternalOptions {\n  operationSelector: OperationSelector;\n  executionManagerOptions: IOperationExecutionManagerOptions;\n  projectSelection: Set<RushConfigurationProject>;\n  operationFactoryOptions: IOperationFactoryOptions;\n  stopwatch: Stopwatch;\n  ignoreHooks?: boolean;\n  terminal: Terminal;\n}\n\n/**\n * This class implements phased commands which are run individually for each project in the repo,\n * possibly in parallel, and which may define multiple phases.\n *\n * @remarks\n * Phased commands can be defined via common/config/command-line.json.  Rush's predefined \"build\"\n * and \"rebuild\" commands are also modeled as phased commands with a single phase that invokes the npm\n * \"build\" script for each project.\n */\nexport class PhasedScriptAction extends BaseScriptAction<IPhasedCommand> {\n  private readonly _enableParallelism: boolean;\n  private readonly _isIncrementalBuildAllowed: boolean;\n  private readonly _disableBuildCache: boolean;\n  private readonly _repoCommandLineConfiguration: CommandLineConfiguration;\n  private readonly _initialPhases: ReadonlySet<IPhase>;\n  private readonly _watchPhases: ReadonlySet<IPhase>;\n  private readonly _alwaysWatch: boolean;\n\n  private _changedProjectsOnly!: CommandLineFlagParameter;\n  private _selectionParameters!: SelectionParameterSet;\n  private _verboseParameter!: CommandLineFlagParameter;\n  private _parallelismParameter: CommandLineStringParameter | undefined;\n  private _ignoreHooksParameter!: CommandLineFlagParameter;\n  private _watchParameter: CommandLineFlagParameter | undefined;\n\n  public constructor(options: IPhasedScriptActionOptions) {\n    super(options);\n    this._enableParallelism = options.enableParallelism;\n    this._isIncrementalBuildAllowed = options.incremental;\n    this._disableBuildCache = options.disableBuildCache;\n    this._repoCommandLineConfiguration = options.commandLineConfiguration;\n    this._initialPhases = options.initialPhases;\n    this._watchPhases = options.watchPhases;\n    this._alwaysWatch = options.alwaysWatch;\n  }\n\n  public async runAsync(): Promise<void> {\n    // TODO: Replace with last-install.flag when \"rush link\" and \"rush unlink\" are deprecated\n    const lastLinkFlag: LastLinkFlag = LastLinkFlagFactory.getCommonTempFlag(this.rushConfiguration);\n    if (!lastLinkFlag.isValid()) {\n      const useWorkspaces: boolean =\n        this.rushConfiguration.pnpmOptions && this.rushConfiguration.pnpmOptions.useWorkspaces;\n      if (useWorkspaces) {\n        throw new Error(`Link flag invalid.${os.EOL}Did you run \"rush install\" or \"rush update\"?`);\n      } else {\n        throw new Error(`Link flag invalid.${os.EOL}Did you run \"rush link\"?`);\n      }\n    }\n\n    this._doBeforeTask();\n\n    const stopwatch: Stopwatch = Stopwatch.start();\n\n    const isQuietMode: boolean = !this._verboseParameter.value;\n\n    // if this is parallelizable, then use the value from the flag (undefined or a number),\n    // if parallelism is not enabled, then restrict to 1 core\n    const parallelism: string | undefined = this._enableParallelism ? this._parallelismParameter!.value : '1';\n\n    const changedProjectsOnly: boolean = this._isIncrementalBuildAllowed && this._changedProjectsOnly.value;\n\n    const terminal: Terminal = new Terminal(this.rushSession.terminalProvider);\n    let buildCacheConfiguration: BuildCacheConfiguration | undefined;\n    if (!this._disableBuildCache) {\n      buildCacheConfiguration = await BuildCacheConfiguration.tryLoadAsync(\n        terminal,\n        this.rushConfiguration,\n        this.rushSession\n      );\n    }\n\n    const projectSelection: Set<RushConfigurationProject> =\n      await this._selectionParameters.getSelectedProjectsAsync(terminal);\n\n    if (!projectSelection.size) {\n      terminal.writeLine(colors.yellow(`The command line selection parameters did not match any projects.`));\n      return;\n    }\n\n    const operationFactoryOptions: IOperationFactoryOptions = {\n      rushConfiguration: this.rushConfiguration,\n      buildCacheConfiguration,\n      isIncrementalBuildAllowed: this._isIncrementalBuildAllowed,\n      customParameters: this.customParameters,\n      projectChangeAnalyzer: new ProjectChangeAnalyzer(this.rushConfiguration)\n    };\n\n    const executionManagerOptions: IOperationExecutionManagerOptions = {\n      quietMode: isQuietMode,\n      debugMode: this.parser.isDebug,\n      parallelism: parallelism,\n      changedProjectsOnly: changedProjectsOnly,\n      repoCommandLineConfiguration: this._repoCommandLineConfiguration\n    };\n\n    const operationSelector: OperationSelector = new OperationSelector({\n      phasesToRun: new Set(this._initialPhases)\n    });\n\n    const isWatch: boolean = this._watchParameter?.value || this._alwaysWatch;\n\n    const executeOptions: IExecuteInternalOptions = {\n      operationSelector,\n      executionManagerOptions,\n      projectSelection,\n      operationFactoryOptions,\n      stopwatch,\n      terminal\n    };\n\n    await this._runOnce(executeOptions);\n\n    if (isWatch) {\n      if (buildCacheConfiguration) {\n        // Cache writes are not supported during watch mode, only reads.\n        buildCacheConfiguration.cacheWriteEnabled = false;\n      }\n      await this._runWatch(executeOptions);\n    }\n  }\n\n  /**\n   * Runs the command in watch mode. Fundamentally is a simple loop:\n   * 1) Wait for a change to one or more projects in the selection\n   * 2) Invoke the command on the changed projects, and, if applicable, impacted projects\n   *    Uses the same algorithm as --impacted-by\n   * 3) Goto (1)\n   */\n  private async _runWatch(options: IExecuteInternalOptions): Promise<void> {\n    const {\n      projectSelection: projectsToWatch,\n      operationFactoryOptions,\n      executionManagerOptions,\n      stopwatch,\n      terminal\n    } = options;\n\n    const operationSelector: OperationSelector = new OperationSelector({\n      phasesToRun: new Set(this._watchPhases)\n    });\n\n    const { projectChangeAnalyzer: initialState } = operationFactoryOptions;\n\n    // Use async import so that we don't pay the cost for sync builds\n    const { ProjectWatcher } = await import('../../logic/ProjectWatcher');\n\n    const projectWatcher: typeof ProjectWatcher.prototype = new ProjectWatcher({\n      debounceMilliseconds: 1000,\n      rushConfiguration: this.rushConfiguration,\n      projectsToWatch,\n      terminal,\n      initialState\n    });\n\n    const onWatchingFiles = (): void => {\n      // Report so that the developer can always see that it is in watch mode as the latest console line.\n      terminal.writeLine(\n        `Watching for changes to ${projectsToWatch.size} ${\n          projectsToWatch.size === 1 ? 'project' : 'projects'\n        }. Press Ctrl+C to exit.`\n      );\n    };\n\n    // Loop until Ctrl+C\n    // eslint-disable-next-line no-constant-condition\n    while (true) {\n      // On the initial invocation, this promise will return immediately with the full set of projects\n      const { changedProjects, state } = await projectWatcher.waitForChange(onWatchingFiles);\n\n      if (stopwatch.state === StopwatchState.Stopped) {\n        // Clear and reset the stopwatch so that we only report time from a single execution at a time\n        stopwatch.reset();\n        stopwatch.start();\n      }\n\n      terminal.writeLine(\n        `Detected changes in ${changedProjects.size} project${changedProjects.size === 1 ? '' : 's'}:`\n      );\n      const names: string[] = [...changedProjects].map((x) => x.packageName).sort();\n      for (const name of names) {\n        terminal.writeLine(`    ${colors.cyan(name)}`);\n      }\n\n      // Account for consumer relationships\n      const projectSelection: Set<RushConfigurationProject> = Selection.intersection(\n        Selection.expandAllConsumers(changedProjects),\n        projectsToWatch\n      );\n\n      const executeOptions: IExecuteInternalOptions = {\n        operationSelector,\n        projectSelection,\n        operationFactoryOptions: {\n          ...operationFactoryOptions,\n          projectChangeAnalyzer: state\n        },\n        executionManagerOptions,\n        stopwatch,\n        // For now, don't run pre-build or post-build in watch mode\n        ignoreHooks: true,\n        terminal\n      };\n\n      try {\n        // Delegate the the underlying command, for only the projects that need reprocessing\n        await this._runOnce(executeOptions);\n      } catch (err) {\n        // In watch mode, we want to rebuild even if the original build failed.\n        if (!(err instanceof AlreadyReportedError)) {\n          throw err;\n        }\n      }\n    }\n  }\n\n  protected onDefineParameters(): void {\n    if (this._enableParallelism) {\n      this._parallelismParameter = this.defineStringParameter({\n        parameterLongName: '--parallelism',\n        parameterShortName: '-p',\n        argumentName: 'COUNT',\n        environmentVariable: EnvironmentVariableNames.RUSH_PARALLELISM,\n        description:\n          'Specifies the maximum number of concurrent processes to launch during a build.' +\n          ' The COUNT should be a positive integer or else the word \"max\" to specify a count that is equal to' +\n          ' the number of CPU cores. If this parameter is omitted, then the default value depends on the' +\n          ' operating system and number of CPU cores.'\n      });\n    }\n\n    this._selectionParameters = new SelectionParameterSet(this.rushConfiguration, this, {\n      // Include lockfile processing since this expands the selection, and we need to select\n      // at least the same projects selected with the same query to \"rush build\"\n      includeExternalDependencies: true,\n      // Enable filtering to reduce evaluation cost\n      enableFiltering: true\n    });\n\n    this._verboseParameter = this.defineFlagParameter({\n      parameterLongName: '--verbose',\n      parameterShortName: '-v',\n      description: 'Display the logs during the build, rather than just displaying the build status summary'\n    });\n\n    if (this._isIncrementalBuildAllowed) {\n      this._changedProjectsOnly = this.defineFlagParameter({\n        parameterLongName: '--changed-projects-only',\n        parameterShortName: '-c',\n        description:\n          'Normally the incremental build logic will rebuild changed projects as well as' +\n          ' any projects that directly or indirectly depend on a changed project. Specify \"--changed-projects-only\"' +\n          ' to ignore dependent projects, only rebuilding those projects whose files were changed.' +\n          ' Note that this parameter is \"unsafe\"; it is up to the developer to ensure that the ignored projects' +\n          ' are okay to ignore.'\n      });\n    }\n\n    this._ignoreHooksParameter = this.defineFlagParameter({\n      parameterLongName: '--ignore-hooks',\n      description: `Skips execution of the \"eventHooks\" scripts defined in rush.json. Make sure you know what you are skipping.`\n    });\n\n    if (this._watchPhases.size > 0 && !this._alwaysWatch) {\n      // Only define the parameter if it has an effect.\n      this._watchParameter = this.defineFlagParameter({\n        parameterLongName: '--watch',\n        description: `Starts a file watcher after initial execution finishes. Will run the following phases on affected projects: ${Array.from(\n          this._watchPhases,\n          (phase: IPhase) => phase.name\n        ).join(', ')}`\n      });\n    }\n\n    this.defineScriptParameters();\n  }\n\n  /**\n   * Runs a single invocation of the command\n   */\n  private async _runOnce(options: IExecuteInternalOptions): Promise<void> {\n    const { operationSelector, projectSelection, operationFactoryOptions } = options;\n\n    const operationFactory: OperationFactory = new OperationFactory(operationFactoryOptions);\n\n    const executionManager: OperationExecutionManager = new OperationExecutionManager(\n      operationSelector.createOperations({\n        projectSelection,\n        operationFactory\n      }),\n      options.executionManagerOptions\n    );\n\n    const { ignoreHooks, stopwatch } = options;\n\n    try {\n      await executionManager.executeAsync();\n\n      stopwatch.stop();\n      console.log(colors.green(`rush ${this.actionName} (${stopwatch.toString()})`));\n\n      if (!ignoreHooks) {\n        this._doAfterTask(stopwatch, true);\n      }\n    } catch (error) {\n      stopwatch.stop();\n\n      if (error instanceof AlreadyReportedError) {\n        console.log(`rush ${this.actionName} (${stopwatch.toString()})`);\n      } else {\n        if (error && (error as Error).message) {\n          if (this.parser.isDebug) {\n            console.log('Error: ' + (error as Error).stack);\n          } else {\n            console.log('Error: ' + (error as Error).message);\n          }\n        }\n\n        console.log(colors.red(`rush ${this.actionName} - Errors! (${stopwatch.toString()})`));\n      }\n\n      if (!ignoreHooks) {\n        this._doAfterTask(stopwatch, false);\n      }\n      throw new AlreadyReportedError();\n    }\n  }\n\n  private _doBeforeTask(): void {\n    if (\n      this.actionName !== RushConstants.buildCommandName &&\n      this.actionName !== RushConstants.rebuildCommandName\n    ) {\n      // Only collects information for built-in tasks like build or rebuild.\n      return;\n    }\n\n    SetupChecks.validate(this.rushConfiguration);\n\n    this.eventHooksManager.handle(Event.preRushBuild, this.parser.isDebug, this._ignoreHooksParameter.value);\n  }\n\n  private _doAfterTask(stopwatch: Stopwatch, success: boolean): void {\n    if (\n      this.actionName !== RushConstants.buildCommandName &&\n      this.actionName !== RushConstants.rebuildCommandName\n    ) {\n      // Only collects information for built-in tasks like build or rebuild.\n      return;\n    }\n    this._collectTelemetry(stopwatch, success);\n    this.parser.flushTelemetry();\n    this.eventHooksManager.handle(Event.postRushBuild, this.parser.isDebug, this._ignoreHooksParameter.value);\n  }\n\n  private _collectTelemetry(stopwatch: Stopwatch, success: boolean): void {\n    const extraData: Record<string, string> = {\n      ...this._selectionParameters.getTelemetry(),\n      ...this.getParameterStringMap()\n    };\n\n    if (this.parser.telemetry) {\n      this.parser.telemetry.log({\n        name: this.actionName,\n        duration: stopwatch.duration,\n        result: success ? 'Succeeded' : 'Failed',\n        extraData\n      });\n    }\n  }\n}\n"]}