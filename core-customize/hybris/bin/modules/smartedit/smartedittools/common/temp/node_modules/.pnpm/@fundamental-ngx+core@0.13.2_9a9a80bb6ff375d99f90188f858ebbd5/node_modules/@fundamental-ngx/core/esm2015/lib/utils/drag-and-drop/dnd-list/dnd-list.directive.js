/**
 * @fileoverview added by tsickle
 * Generated from: lib/utils/drag-and-drop/dnd-list/dnd-list.directive.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { ContentChildren, Directive, EventEmitter, Input, Output, QueryList } from '@angular/core';
import { DndContainerDirective } from '../dnd-container/dnd-container.directive';
import { Subject } from 'rxjs';
import { takeUntil } from 'rxjs/operators';
/**
 * @record
 */
export function ElementChord() { }
if (false) {
    /** @type {?} */
    ElementChord.prototype.x;
    /** @type {?} */
    ElementChord.prototype.y;
    /** @type {?} */
    ElementChord.prototype.position;
    /** @type {?|undefined} */
    ElementChord.prototype.stickToPosition;
}
export class DndListDirective {
    constructor() {
        /**
         * Defines if the distance between elements should be counted only by vertical distance
         */
        this.listMode = false;
        /**
         * Event that is thrown, when the item is dropped
         */
        this.itemsChange = new EventEmitter();
        /**
         * @hidden
         */
        this.draggedItemIndex = 1000000;
        /**
         * @hidden
         */
        this.closestLinkIndex = null;
        /**
         * @hidden
         */
        this.closestLinkPosition = null;
        /**
         * An RxJS Subject that will kill the current data stream (for unsubscribing)
         */
        this.refresh$ = new Subject();
    }
    /**
     * @hidden
     * @return {?}
     */
    ngAfterContentInit() {
        this.refreshQueryList();
        this.dndContainerItems.changes.subscribe((/**
         * @return {?}
         */
        () => this.refreshQueryList()));
    }
    /**
     * Method called, when the item is being moved by 1 px
     * @param {?} event
     * @return {?}
     */
    onMove(event) {
        /**
         * Taking mouse position
         * @type {?}
         */
        const mousePosition = event.pointerPosition;
        /**
         * Temporary object, to store lowest distance values
         * @type {?}
         */
        let lowestDistanceItem = null;
        this.elementChords.forEach((/**
         * @param {?} element
         * @param {?} index
         * @return {?}
         */
        (element, index) => {
            /** Check if element can be replaced */
            if (!element.stickToPosition) {
                /**
                 * Counting the distances by the mileage of the corner of element and cursor position
                 * @type {?}
                 */
                const distance = Math.hypot(element.x - mousePosition.x, element.y - mousePosition.y);
                if (!lowestDistanceItem || distance < lowestDistanceItem.distance) {
                    lowestDistanceItem = { distance: distance, index: index };
                }
            }
        }));
        /** If the closest element is different than the old one, new one is picked. It prevents from performance issues */
        if (lowestDistanceItem.index !== this.closestLinkIndex) {
            this.closestLinkIndex = lowestDistanceItem.index;
            this.closestLinkPosition = this.elementChords[lowestDistanceItem.index].position;
            /** Generating line, that shows where the element will be placed, on drop */
            this.generateLine(this.closestLinkIndex, this.closestLinkPosition);
        }
    }
    /**
     * Method called, when element is started to be dragged
     * @param {?} ind
     * @return {?}
     */
    dragStart(ind) {
        this.draggedItemIndex = ind;
        /** @type {?} */
        const draggedItemElement = this.dndContainerItems.toArray()[ind].element;
        /** Counting all of the elements's chords */
        this.elementChords = this.dndContainerItems.toArray().map((/**
         * @param {?} link
         * @return {?}
         */
        (link) => link.getElementChord(this.isBefore(draggedItemElement, link.element), this.listMode)));
    }
    /**
     * Method called, when element is released
     * @return {?}
     */
    dragEnd() {
        /** @type {?} */
        const draggedItemIndex = this.draggedItemIndex;
        /** @type {?} */
        const replacedItemIndex = this.closestLinkIndex;
        /** @type {?} */
        const draggedItem = this.items[draggedItemIndex];
        if (draggedItemIndex < replacedItemIndex) {
            for (let i = draggedItemIndex; i < replacedItemIndex; i++) {
                this.items[i] = this.items[i + 1];
            }
        }
        else {
            for (let i = draggedItemIndex; i > replacedItemIndex; i--) {
                this.items[i] = this.items[i - 1];
            }
        }
        /** Replacing items */
        this.items[replacedItemIndex] = draggedItem;
        this.itemsChange.emit(this.items);
        this.removeAllLines();
        /** Reset */
        this.elementChords = [];
        this.closestLinkIndex = null;
        this.closestLinkPosition = null;
    }
    /**
     * @hidden
     * @private
     * @return {?}
     */
    removeAllLines() {
        this.dndContainerItems.forEach((/**
         * @param {?} item
         * @return {?}
         */
        item => item.removeLine()));
    }
    /**
     * @hidden
     * @private
     * @param {?} closestLinkIndex
     * @param {?} linkPosition
     * @return {?}
     */
    generateLine(closestLinkIndex, linkPosition) {
        this.removeAllLines();
        this.dndContainerItems.toArray()[closestLinkIndex].createLine(linkPosition, this.listMode);
    }
    /**
     * @hidden
     * @private
     * @return {?}
     */
    refreshQueryList() {
        this.refresh$.next();
        this.dndContainerItems.forEach((/**
         * @param {?} item
         * @param {?} index
         * @return {?}
         */
        (item, index) => {
            item.moved.pipe(takeUntil(this.refresh$)).subscribe((/**
             * @param {?} eventMove
             * @return {?}
             */
            eventMove => this.onMove(eventMove)));
            item.started.pipe(takeUntil(this.refresh$)).subscribe((/**
             * @return {?}
             */
            () => this.dragStart(index)));
            item.released.pipe(takeUntil(this.refresh$)).subscribe((/**
             * @return {?}
             */
            () => this.dragEnd()));
        }));
    }
    /**
     * @hidden
     * Return information if element is placed before the dragged element
     * @private
     * @param {?} draggedElement
     * @param {?} targetElement
     * @return {?}
     */
    isBefore(draggedElement, targetElement) {
        /**
         * Sometimes the element are not straight in one column, that's why offset is needed
         * @type {?}
         */
        const VERTICAL_OFFSET = 20;
        /**
         * Distances from the top of screen
         * @type {?}
         */
        const draggedElementBound = (/** @type {?} */ (draggedElement.nativeElement.getBoundingClientRect()));
        /** @type {?} */
        const targetElementBound = (/** @type {?} */ (targetElement.nativeElement.getBoundingClientRect()));
        if (draggedElementBound.y - targetElementBound.y > VERTICAL_OFFSET) {
            /** If element is higher than the dragged element, it's for sure before */
            return true;
        }
        else if (targetElementBound.y - draggedElementBound.y > VERTICAL_OFFSET) {
            /** If element is lower than the dragged element, it's for sure after */
            return false;
        }
        else {
            /** If elements are in same level, the horizontal position decides if it's before/after */
            return draggedElementBound.x - targetElementBound.x > 0;
        }
    }
}
DndListDirective.decorators = [
    { type: Directive, args: [{
                // tslint:disable-next-line:directive-selector
                selector: '[fd-dnd-list]',
            },] }
];
DndListDirective.propDecorators = {
    dndContainerItems: [{ type: ContentChildren, args: [DndContainerDirective,] }],
    listMode: [{ type: Input }],
    items: [{ type: Input }],
    itemsChange: [{ type: Output }]
};
if (false) {
    /**
     * @hidden
     * @type {?}
     */
    DndListDirective.prototype.dndContainerItems;
    /**
     * Defines if the distance between elements should be counted only by vertical distance
     * @type {?}
     */
    DndListDirective.prototype.listMode;
    /**
     * Array of items, that will be sorted
     * @type {?}
     */
    DndListDirective.prototype.items;
    /**
     * Event that is thrown, when the item is dropped
     * @type {?}
     */
    DndListDirective.prototype.itemsChange;
    /**
     * @hidden
     * @type {?}
     * @private
     */
    DndListDirective.prototype.elementChords;
    /**
     * @hidden
     * @type {?}
     * @private
     */
    DndListDirective.prototype.draggedItemIndex;
    /**
     * @hidden
     * @type {?}
     * @private
     */
    DndListDirective.prototype.closestLinkIndex;
    /**
     * @hidden
     * @type {?}
     * @private
     */
    DndListDirective.prototype.closestLinkPosition;
    /**
     * An RxJS Subject that will kill the current data stream (for unsubscribing)
     * @type {?}
     * @private
     */
    DndListDirective.prototype.refresh$;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG5kLWxpc3QuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZ1bmRhbWVudGFsLW5neC9jb3JlLyIsInNvdXJjZXMiOlsibGliL3V0aWxzL2RyYWctYW5kLWRyb3AvZG5kLWxpc3QvZG5kLWxpc3QuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFvQixlQUFlLEVBQUUsU0FBUyxFQUFjLFlBQVksRUFBRSxLQUFLLEVBQVUsTUFBTSxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUV6SSxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSwwQ0FBMEMsQ0FBQztBQUNqRixPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQy9CLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7OztBQUszQyxrQ0FLQzs7O0lBSkcseUJBQVU7O0lBQ1YseUJBQVU7O0lBQ1YsZ0NBQXVCOztJQUN2Qix1Q0FBeUI7O0FBTzdCLE1BQU0sT0FBTyxnQkFBZ0I7SUFKN0I7Ozs7UUFZSSxhQUFRLEdBQVksS0FBSyxDQUFDOzs7O1FBUWpCLGdCQUFXLEdBQTZCLElBQUksWUFBWSxFQUFPLENBQUM7Ozs7UUFNakUscUJBQWdCLEdBQVcsT0FBTyxDQUFDOzs7O1FBR25DLHFCQUFnQixHQUFXLElBQUksQ0FBQzs7OztRQUdoQyx3QkFBbUIsR0FBdUIsSUFBSSxDQUFDOzs7O1FBR3RDLGFBQVEsR0FBa0IsSUFBSSxPQUFPLEVBQVEsQ0FBQztJQStIbkUsQ0FBQzs7Ozs7SUE1SFUsa0JBQWtCO1FBQ3JCLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQ3hCLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsU0FBUzs7O1FBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLGdCQUFnQixFQUFFLEVBQUMsQ0FBQztJQUM1RSxDQUFDOzs7Ozs7SUFHRCxNQUFNLENBQUMsS0FBa0I7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RCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFmdGVyQ29udGVudEluaXQsIENvbnRlbnRDaGlsZHJlbiwgRGlyZWN0aXZlLCBFbGVtZW50UmVmLCBFdmVudEVtaXR0ZXIsIElucHV0LCBPbkluaXQsIE91dHB1dCwgUXVlcnlMaXN0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBDZGtEcmFnLCBDZGtEcmFnTW92ZSB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9kcmFnLWRyb3AnO1xuaW1wb3J0IHsgRG5kQ29udGFpbmVyRGlyZWN0aXZlIH0gZnJvbSAnLi4vZG5kLWNvbnRhaW5lci9kbmQtY29udGFpbmVyLmRpcmVjdGl2ZSc7XG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cblxuZXhwb3J0IHR5cGUgTGlua1Bvc2l0aW9uID0gJ2FmdGVyJyB8ICdiZWZvcmUnO1xuXG5leHBvcnQgaW50ZXJmYWNlIEVsZW1lbnRDaG9yZCB7XG4gICAgeDogbnVtYmVyO1xuICAgIHk6IG51bWJlcjtcbiAgICBwb3NpdGlvbjogTGlua1Bvc2l0aW9uO1xuICAgIHN0aWNrVG9Qb3NpdGlvbj86IGJvb2xlYW5cbn1cblxuQERpcmVjdGl2ZSh7XG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOmRpcmVjdGl2ZS1zZWxlY3RvclxuICBzZWxlY3RvcjogJ1tmZC1kbmQtbGlzdF0nLFxufSlcbmV4cG9ydCBjbGFzcyBEbmRMaXN0RGlyZWN0aXZlIGltcGxlbWVudHMgQWZ0ZXJDb250ZW50SW5pdCB7XG5cbiAgICAvKiogQGhpZGRlbiAqL1xuICAgIEBDb250ZW50Q2hpbGRyZW4oRG5kQ29udGFpbmVyRGlyZWN0aXZlKVxuICAgIGRuZENvbnRhaW5lckl0ZW1zOiBRdWVyeUxpc3Q8RG5kQ29udGFpbmVyRGlyZWN0aXZlPjtcblxuICAgIC8qKiBEZWZpbmVzIGlmIHRoZSBkaXN0YW5jZSBiZXR3ZWVuIGVsZW1lbnRzIHNob3VsZCBiZSBjb3VudGVkIG9ubHkgYnkgdmVydGljYWwgZGlzdGFuY2UgKi9cbiAgICBASW5wdXQoKVxuICAgIGxpc3RNb2RlOiBib29sZWFuID0gZmFsc2U7XG5cbiAgICAvKiogQXJyYXkgb2YgaXRlbXMsIHRoYXQgd2lsbCBiZSBzb3J0ZWQgKi9cbiAgICBASW5wdXQoKVxuICAgIHB1YmxpYyBpdGVtczogQXJyYXk8YW55PjtcblxuICAgIC8qKiBFdmVudCB0aGF0IGlzIHRocm93biwgd2hlbiB0aGUgaXRlbSBpcyBkcm9wcGVkICovXG4gICAgQE91dHB1dCgpXG4gICAgcmVhZG9ubHkgaXRlbXNDaGFuZ2U6IEV2ZW50RW1pdHRlcjxBcnJheTxhbnk+PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gICAgLyoqIEBoaWRkZW4gKi9cbiAgICBwcml2YXRlIGVsZW1lbnRDaG9yZHM6IEVsZW1lbnRDaG9yZFtdO1xuXG4gICAgLyoqIEBoaWRkZW4gKi9cbiAgICBwcml2YXRlIGRyYWdnZWRJdGVtSW5kZXg6IG51bWJlciA9IDEwMDAwMDA7XG5cbiAgICAvKiogQGhpZGRlbiAqL1xuICAgIHByaXZhdGUgY2xvc2VzdExpbmtJbmRleDogbnVtYmVyID0gbnVsbDtcblxuICAgIC8qKiBAaGlkZGVuICovXG4gICAgcHJpdmF0ZSBjbG9zZXN0TGlua1Bvc2l0aW9uOiAnYmVmb3JlJyB8ICdhZnRlcicgPSBudWxsO1xuXG4gICAgLyoqIEFuIFJ4SlMgU3ViamVjdCB0aGF0IHdpbGwga2lsbCB0aGUgY3VycmVudCBkYXRhIHN0cmVhbSAoZm9yIHVuc3Vic2NyaWJpbmcpICAqL1xuICAgIHByaXZhdGUgcmVhZG9ubHkgcmVmcmVzaCQ6IFN1YmplY3Q8dm9pZD4gPSBuZXcgU3ViamVjdDx2b2lkPigpO1xuXG4gICAgLyoqIEBoaWRkZW4gKi9cbiAgICBwdWJsaWMgbmdBZnRlckNvbnRlbnRJbml0KCk6IHZvaWQge1xuICAgICAgICB0aGlzLnJlZnJlc2hRdWVyeUxpc3QoKTtcbiAgICAgICAgdGhpcy5kbmRDb250YWluZXJJdGVtcy5jaGFuZ2VzLnN1YnNjcmliZSgoKSA9PiB0aGlzLnJlZnJlc2hRdWVyeUxpc3QoKSk7XG4gICAgfVxuXG4gICAgLyoqIE1ldGhvZCBjYWxsZWQsIHdoZW4gdGhlIGl0ZW0gaXMgYmVpbmcgbW92ZWQgYnkgMSBweCAqL1xuICAgIG9uTW92ZShldmVudDogQ2RrRHJhZ01vdmUpOiB2b2lkIHtcbiAgICAgICAgLyoqIFRha2luZyBtb3VzZSBwb3NpdGlvbiAqL1xuICAgICAgICBjb25zdCBtb3VzZVBvc2l0aW9uOiB7XG4gICAgICAgICAgICB4OiBudW1iZXI7XG4gICAgICAgICAgICB5OiBudW1iZXI7XG4gICAgICAgIH0gPSBldmVudC5wb2ludGVyUG9zaXRpb247XG5cbiAgICAgICAgLyoqIFRlbXBvcmFyeSBvYmplY3QsIHRvIHN0b3JlIGxvd2VzdCBkaXN0YW5jZSB2YWx1ZXMgKi9cbiAgICAgICAgbGV0IGxvd2VzdERpc3RhbmNlSXRlbToge1xuICAgICAgICAgICAgaW5kZXg6IG51bWJlcixcbiAgICAgICAgICAgIGRpc3RhbmNlOiBudW1iZXJcbiAgICAgICAgfSA9IG51bGw7XG5cbiAgICAgICAgdGhpcy5lbGVtZW50Q2hvcmRzLmZvckVhY2goKGVsZW1lbnQsIGluZGV4KSA9PiB7XG4gICAgICAgICAgICAvKiogQ2hlY2sgaWYgZWxlbWVudCBjYW4gYmUgcmVwbGFjZWQgKi9cbiAgICAgICAgICAgIGlmICghZWxlbWVudC5zdGlja1RvUG9zaXRpb24pIHtcbiAgICAgICAgICAgICAgICAvKiogQ291bnRpbmcgdGhlIGRpc3RhbmNlcyBieSB0aGUgbWlsZWFnZSBvZiB0aGUgY29ybmVyIG9mIGVsZW1lbnQgYW5kIGN1cnNvciBwb3NpdGlvbiAqL1xuICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RhbmNlID0gTWF0aC5oeXBvdChlbGVtZW50LnggLSBtb3VzZVBvc2l0aW9uLngsIGVsZW1lbnQueSAtIG1vdXNlUG9zaXRpb24ueSk7XG4gICAgICAgICAgICAgICAgaWYgKCFsb3dlc3REaXN0YW5jZUl0ZW0gfHwgZGlzdGFuY2UgPCBsb3dlc3REaXN0YW5jZUl0ZW0uZGlzdGFuY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgbG93ZXN0RGlzdGFuY2VJdGVtID0geyBkaXN0YW5jZTogZGlzdGFuY2UsIGluZGV4OiBpbmRleCB9O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgLyoqIElmIHRoZSBjbG9zZXN0IGVsZW1lbnQgaXMgZGlmZmVyZW50IHRoYW4gdGhlIG9sZCBvbmUsIG5ldyBvbmUgaXMgcGlja2VkLiBJdCBwcmV2ZW50cyBmcm9tIHBlcmZvcm1hbmNlIGlzc3VlcyAqL1xuICAgICAgICBpZiAobG93ZXN0RGlzdGFuY2VJdGVtLmluZGV4ICE9PSB0aGlzLmNsb3Nlc3RMaW5rSW5kZXgpIHtcbiAgICAgICAgICAgIHRoaXMuY2xvc2VzdExpbmtJbmRleCA9IGxvd2VzdERpc3RhbmNlSXRlbS5pbmRleDtcbiAgICAgICAgICAgIHRoaXMuY2xvc2VzdExpbmtQb3NpdGlvbiA9IHRoaXMuZWxlbWVudENob3Jkc1tsb3dlc3REaXN0YW5jZUl0ZW0uaW5kZXhdLnBvc2l0aW9uO1xuICAgICAgICAgICAgLyoqIEdlbmVyYXRpbmcgbGluZSwgdGhhdCBzaG93cyB3aGVyZSB0aGUgZWxlbWVudCB3aWxsIGJlIHBsYWNlZCwgb24gZHJvcCAqL1xuICAgICAgICAgICAgdGhpcy5nZW5lcmF0ZUxpbmUodGhpcy5jbG9zZXN0TGlua0luZGV4LCB0aGlzLmNsb3Nlc3RMaW5rUG9zaXRpb24pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqIE1ldGhvZCBjYWxsZWQsIHdoZW4gZWxlbWVudCBpcyBzdGFydGVkIHRvIGJlIGRyYWdnZWQgKi9cbiAgICBkcmFnU3RhcnQoaW5kOiBudW1iZXIpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5kcmFnZ2VkSXRlbUluZGV4ID0gaW5kO1xuICAgICAgICBjb25zdCBkcmFnZ2VkSXRlbUVsZW1lbnQgPSB0aGlzLmRuZENvbnRhaW5lckl0ZW1zLnRvQXJyYXkoKVtpbmRdLmVsZW1lbnQ7XG4gICAgICAgIC8qKiBDb3VudGluZyBhbGwgb2YgdGhlIGVsZW1lbnRzJ3MgY2hvcmRzICovXG4gICAgICAgIHRoaXMuZWxlbWVudENob3JkcyA9IHRoaXMuZG5kQ29udGFpbmVySXRlbXMudG9BcnJheSgpLm1hcCgobGluaykgPT5cbiAgICAgICAgICAgIGxpbmsuZ2V0RWxlbWVudENob3JkKHRoaXMuaXNCZWZvcmUoZHJhZ2dlZEl0ZW1FbGVtZW50LCBsaW5rLmVsZW1lbnQpLCB0aGlzLmxpc3RNb2RlKVxuICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKiBNZXRob2QgY2FsbGVkLCB3aGVuIGVsZW1lbnQgaXMgcmVsZWFzZWQgKi9cbiAgICBkcmFnRW5kKCk6IHZvaWQge1xuXG4gICAgICAgIGNvbnN0IGRyYWdnZWRJdGVtSW5kZXggPSB0aGlzLmRyYWdnZWRJdGVtSW5kZXg7XG4gICAgICAgIGNvbnN0IHJlcGxhY2VkSXRlbUluZGV4ID0gdGhpcy5jbG9zZXN0TGlua0luZGV4O1xuICAgICAgICBjb25zdCBkcmFnZ2VkSXRlbSA9IHRoaXMuaXRlbXNbZHJhZ2dlZEl0ZW1JbmRleF07XG5cbiAgICAgICAgaWYgKGRyYWdnZWRJdGVtSW5kZXggPCByZXBsYWNlZEl0ZW1JbmRleCkge1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IGRyYWdnZWRJdGVtSW5kZXg7IGkgPCByZXBsYWNlZEl0ZW1JbmRleDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5pdGVtc1tpXSA9IHRoaXMuaXRlbXNbaSArIDFdO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IGRyYWdnZWRJdGVtSW5kZXg7IGkgPiByZXBsYWNlZEl0ZW1JbmRleDsgaS0tKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5pdGVtc1tpXSA9IHRoaXMuaXRlbXNbaSAtIDFdO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLyoqIFJlcGxhY2luZyBpdGVtcyAqL1xuICAgICAgICB0aGlzLml0ZW1zW3JlcGxhY2VkSXRlbUluZGV4XSA9IGRyYWdnZWRJdGVtO1xuXG4gICAgICAgIHRoaXMuaXRlbXNDaGFuZ2UuZW1pdCh0aGlzLml0ZW1zKTtcblxuICAgICAgICB0aGlzLnJlbW92ZUFsbExpbmVzKCk7XG5cbiAgICAgICAgLyoqIFJlc2V0ICovXG4gICAgICAgIHRoaXMuZWxlbWVudENob3JkcyA9IFtdO1xuICAgICAgICB0aGlzLmNsb3Nlc3RMaW5rSW5kZXggPSBudWxsO1xuICAgICAgICB0aGlzLmNsb3Nlc3RMaW5rUG9zaXRpb24gPSBudWxsO1xuICAgIH1cblxuICAgIC8qKiBAaGlkZGVuICovXG4gICAgcHJpdmF0ZSByZW1vdmVBbGxMaW5lcygpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5kbmRDb250YWluZXJJdGVtcy5mb3JFYWNoKGl0ZW0gPT4gaXRlbS5yZW1vdmVMaW5lKCkpO1xuICAgIH1cblxuICAgIC8qKiBAaGlkZGVuICovXG4gICAgcHJpdmF0ZSBnZW5lcmF0ZUxpbmUoY2xvc2VzdExpbmtJbmRleDogbnVtYmVyLCBsaW5rUG9zaXRpb246IExpbmtQb3NpdGlvbik6IHZvaWQge1xuICAgICAgICB0aGlzLnJlbW92ZUFsbExpbmVzKCk7XG4gICAgICAgIHRoaXMuZG5kQ29udGFpbmVySXRlbXMudG9BcnJheSgpW2Nsb3Nlc3RMaW5rSW5kZXhdLmNyZWF0ZUxpbmUobGlua1Bvc2l0aW9uLCB0aGlzLmxpc3RNb2RlKTtcbiAgICB9XG5cbiAgICAvKiogQGhpZGRlbiAqL1xuICAgIHByaXZhdGUgcmVmcmVzaFF1ZXJ5TGlzdCgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5yZWZyZXNoJC5uZXh0KCk7XG4gICAgICAgIHRoaXMuZG5kQ29udGFpbmVySXRlbXMuZm9yRWFjaCgoaXRlbSwgaW5kZXgpID0+IHtcbiAgICAgICAgICAgIGl0ZW0ubW92ZWQucGlwZSh0YWtlVW50aWwodGhpcy5yZWZyZXNoJCkpLnN1YnNjcmliZShldmVudE1vdmUgPT4gdGhpcy5vbk1vdmUoZXZlbnRNb3ZlKSk7XG4gICAgICAgICAgICBpdGVtLnN0YXJ0ZWQucGlwZSh0YWtlVW50aWwodGhpcy5yZWZyZXNoJCkpLnN1YnNjcmliZSgoKSA9PiB0aGlzLmRyYWdTdGFydChpbmRleCkpO1xuICAgICAgICAgICAgaXRlbS5yZWxlYXNlZC5waXBlKHRha2VVbnRpbCh0aGlzLnJlZnJlc2gkKSkuc3Vic2NyaWJlKCgpID0+IHRoaXMuZHJhZ0VuZCgpKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogIEBoaWRkZW5cbiAgICAgKiBSZXR1cm4gaW5mb3JtYXRpb24gaWYgZWxlbWVudCBpcyBwbGFjZWQgYmVmb3JlIHRoZSBkcmFnZ2VkIGVsZW1lbnRcbiAgICAgKi9cbiAgICBwcml2YXRlIGlzQmVmb3JlKGRyYWdnZWRFbGVtZW50OiBFbGVtZW50UmVmLCB0YXJnZXRFbGVtZW50OiBFbGVtZW50UmVmKTogYm9vbGVhbiB7XG5cbiAgICAgICAgLyoqIFNvbWV0aW1lcyB0aGUgZWxlbWVudCBhcmUgbm90IHN0cmFpZ2h0IGluIG9uZSBjb2x1bW4sIHRoYXQncyB3aHkgb2Zmc2V0IGlzIG5lZWRlZCAqL1xuICAgICAgICBjb25zdCBWRVJUSUNBTF9PRkZTRVQ6IG51bWJlciA9IDIwO1xuXG4gICAgICAgIC8qKiBEaXN0YW5jZXMgZnJvbSB0aGUgdG9wIG9mIHNjcmVlbiAqL1xuICAgICAgICBjb25zdCBkcmFnZ2VkRWxlbWVudEJvdW5kID0gPERPTVJlY3Q+ZHJhZ2dlZEVsZW1lbnQubmF0aXZlRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICAgICAgY29uc3QgdGFyZ2V0RWxlbWVudEJvdW5kID0gPERPTVJlY3Q+dGFyZ2V0RWxlbWVudC5uYXRpdmVFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuXG4gICAgICAgIGlmIChkcmFnZ2VkRWxlbWVudEJvdW5kLnkgLSB0YXJnZXRFbGVtZW50Qm91bmQueSA+IFZFUlRJQ0FMX09GRlNFVCkge1xuICAgICAgICAgICAgLyoqIElmIGVsZW1lbnQgaXMgaGlnaGVyIHRoYW4gdGhlIGRyYWdnZWQgZWxlbWVudCwgaXQncyBmb3Igc3VyZSBiZWZvcmUgKi9cbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9IGVsc2UgaWYgKHRhcmdldEVsZW1lbnRCb3VuZC55IC0gZHJhZ2dlZEVsZW1lbnRCb3VuZC55ID4gVkVSVElDQUxfT0ZGU0VUKSB7XG4gICAgICAgICAgICAvKiogSWYgZWxlbWVudCBpcyBsb3dlciB0aGFuIHRoZSBkcmFnZ2VkIGVsZW1lbnQsIGl0J3MgZm9yIHN1cmUgYWZ0ZXIgKi9cbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8qKiBJZiBlbGVtZW50cyBhcmUgaW4gc2FtZSBsZXZlbCwgdGhlIGhvcml6b250YWwgcG9zaXRpb24gZGVjaWRlcyBpZiBpdCdzIGJlZm9yZS9hZnRlciAqL1xuICAgICAgICAgICAgcmV0dXJuIGRyYWdnZWRFbGVtZW50Qm91bmQueCAtIHRhcmdldEVsZW1lbnRCb3VuZC54ID4gMDtcbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==